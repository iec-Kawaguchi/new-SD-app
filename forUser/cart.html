<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>Course Catalog / Checkout</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajaxzip3.github.io/ajaxzip3.js" charset="UTF-8"></script>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
        <style>
            body { font-family: "游ゴシック体", "Yu Gothic", "游ゴシック", YuGothic, sans-serif; }
            :root { --safe-bottom: env(safe-area-inset-bottom); }
            /* モバイル用入力調整 */
            input[data-numeric] { ime-mode: disabled; }
            
            /* エラー時のスタイル定義 */
            .input-error {
                border-color: #ef4444 !important; /* red-500 */
                background-color: #fef2f2 !important; /* red-50 */
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen flex flex-col">
        <header class="sticky top-0 z-40 border-b border-gray-200/70 bg-white/80 backdrop-blur">
            <div class="max-w-6xl mx-auto h-14 flex items-center px-4">
                <a href="top.html" class="font-bold text-lg tracking-tight">Course Catalog</a>
                <nav class="ml-auto flex items-center gap-1">
                    <a href="#" class="relative p-2 rounded-full hover:bg-gray-100" aria-label="Cart">
                        <span class="material-symbols-outlined align-middle">shopping_cart</span>
                        <span id="cart-badge" class="absolute -top-1 -right-1 text-[10px] h-4 w-4 grid place-items-center rounded-full bg-rose-500 text-white">1</span>
                    </a>
                    <button class="p-2 rounded-full hover:bg-gray-100" aria-label="Profile">
                        <span class="material-symbols-outlined align-middle">account_circle</span>
                    </button>
                </nav>
            </div>
        </header>

        <main class="flex-1">
            <div class="max-w-6xl w-full mx-auto p-4 md:p-6">
                <ol class="flex items-center gap-2 text-sm text-gray-600 mb-4" aria-label="進行状況">
                    <li class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-800 text-white grid place-items-center text-xs font-">1</span><span>カート</span></li>
                    <li class="text-gray-400">—</li>
                    <li class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-800 text-white grid place-items-center text-xs">2</span><span>情報入力</span></li>
                    <li class="text-gray-400">—</li>
                    <li class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-300 text-gray-700 grid place-items-center text-xs">3</span><span>確認・確定</span></li>
                </ol>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 space-y-8">
                        <section class="bg-white rounded-xl shadow p-5">
                            <h2 class="text-xl font-bold border-l-4 border-gray-700 pl-2 mb-4">カート</h2>
                            <ul id="cart-list" class="space-y-4">
                                <li class="flex items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium truncate">Excel マクロ＆VBA入門</p>
                                        <p class="text-sm text-gray-500">コースNo: 101</p>
                                        <button type="button" class="text-sm text-gray-500 hover:text-red-600 underline mt-1" data-remove>削除</button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="hidden">
                                            <input class="w-12 text-center outline-none" type="number" min="1" value="1" data-qty />
                                        </div>
                                        <div class="w-24 text-right">
                                            <span class="font-semibold" data-price="19910" data-line-total>¥19,910</span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </section>

                        <section class="bg-white rounded-xl shadow p-5">
                            <h2 class="text-xl font-bold border-l-4 border-gray-700 pl-2 mb-4">基本情報</h2>
                            <form id="checkout-form" class="space-y-6" novalidate>
                                <div class="flex flex-col">
                                    <span class="font-medium">受講区分 <span class="text-red-500">*</span></span>
                                    <div class="mt-2 flex flex-wrap gap-4">
                                        <label class="inline-flex items-center gap-2">
                                            <input id="enrollType" type="radio" name="enrollType" value="new" class="accent-blue-600" checked>
                                            <span>新規受講</span>
                                        </label>
                                        <label class="inline-flex items-center gap-2">
                                            <input type="radio" name="enrollType" value="re" class="accent-blue-600">
                                            <span>再受講</span>
                                        </label>
                                    </div>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="enrollType">受講区分を選択してください。</p>
                                </div>

                                <div id="re-enroll-block" class="flex flex-col sm:w-1/2 hidden">
                                    <label for="prevEnrollNo" class="font-medium">前回の受講番号 <span class="text-red-500">*</span></label>
                                    <input id="prevEnrollNo" name="prevEnrollNo" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="off" />
                                    <p class="text-sm text-gray-500 mt-1">受講証やメールに記載の「受講番号」を入力してください。</p>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="prevEnrollNo">前回の受講番号を入力してください。</p>
                                </div>

                                <div class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                                    <div class="flex flex-col">
                                        <label for="name_sei" class="font-medium">姓 <span class="text-red-500">*</span></label>
                                        <input id="name_sei" name="name_sei" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="family-name" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="kana_sei" class="font-medium">セイ <span class="text-red-500">*</span></label>
                                        <input id="kana_sei" name="kana_sei" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="" pattern="^[\u30A0-\u30FF\sー－]+$" required />
                                        <p class="text-xs text-gray-500 mt-1">全角カタカナ</p>
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="name_mei" class="font-medium">名 <span class="text-red-500">*</span></label>
                                        <input id="name_mei" name="name_mei" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="given-name" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="kana_mei" class="font-medium">メイ <span class="text-red-500">*</span></label>
                                        <input id="kana_mei" name="kana_mei" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="" pattern="^[\u30A0-\u30FF\sー－]+$" required />
                                        <p class="text-xs text-gray-500 mt-1">全角カタカナ</p>
                                    </div>
                                </div>

                                <div class="flex flex-col space-y-2">
                                    <div class="flex flex-col">
                                        <label for="email" class="font-medium">
                                            メールアドレス <span class="text-red-500">*</span>
                                        </label>
                                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-1">
                                            <input id="email" name="email" type="email" class="border rounded-lg p-2 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="email" required />
                                            <button type="button" id="send-otp" class="px-3 py-2 text-sm rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 whitespace-nowrap">
                                                認証コードを送信
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">入力したメールアドレス宛にワンタイム認証コードを送信します。</p>
                                        <p class="text-sm text-red-600 mt-1 hidden" data-error-for="email">有効なメールアドレスを入力してください。</p>
                                    </div>

                                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 flex-1">
                                            <input id="emailOtp" name="emailOtp" type="text" class="border rounded-lg p-2 flex-1 disabled:bg-gray-100 disabled:text-gray-400" placeholder="6桁の認証コード" maxlength="6" inputmode="numeric" data-numeric disabled />
                                            <button type="button" id="verify-otp" class="px-3 py-2 text-sm rounded-lg border border-gray-400 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                                認証
                                            </button>
                                        </div>
                                    </div>

                                    <div class="text-xs mt-1">
                                        <span id="otp-status" class="text-gray-500">認証コード未送信</span>
                                        <span id="otp-demo" class="ml-2 text-[11px] text-gray-400"></span>
                                    </div>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="emailOtp">メールアドレスの認証を完了してください。</p>
                                </div>

                                <div class="flex flex-col sm:w-1/2">
                                    <label for="tel" class="font-medium">電話番号 <span class="text-red-500">*</span></label>
                                    <input id="tel" name="tel" type="tel" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" inputmode="numeric" data-numeric autocomplete="tel" placeholder="09012345678" pattern="^[0-9\-]+$" required />
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="tel">電話番号を正しく入力してください。</p>
                                </div>

                                <div class="pt-2">
                                    <label class="inline-flex items-start gap-2">
                                        <input id="agree" type="checkbox" class="mt-1" disabled>
                                        <span class="text-sm text-gray-700">
                                            <button type="button" id="open-privacy" class="underline text-blue-700 hover:text-blue-900">
                                                プライバシーポリシー
                                            </button>
                                            を確認のうえ、内容に同意します
                                        </span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">ポリシーを確認し「同意する」ボタンを押すとチェックが付きます。</p>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="agree">プライバシーポリシーへの同意が必要です。</p>
                                </div>
                            </form>
                        </section>

                        <section class="bg-white rounded-xl shadow p-5">
                            <h2 class="text-xl font-bold border-l-4 border-gray-700 pl-2 mb-4">配送先</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="flex flex-col">
                                    <label for="zip" class="font-medium">郵便番号 <span class="text-red-500">*</span></label>
                                    <input id="zip" name="zip" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" inputmode="numeric" data-numeric placeholder="123-4567" pattern="^\d{3}-?\d{4}$" maxlength="8" required />
                                    <p class="text-xs text-gray-500 mt-1">半角数字（自動でハイフンが入ります）</p>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="zip">郵便番号を正しく入力してください。</p>
                                </div>
                                <div class="flex flex-col">
                                    <label for="pref" class="font-medium">都道府県 <span class="text-red-500">*</span></label>
                                    <input id="pref" name="pref" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="address-level1" required />
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="pref">都道府県を入力してください。</p>
                                </div>
                                <div class="flex flex-col sm:col-span-2">
                                    <label for="city" class="font-medium">市区町村・番地 <span class="text-red-500">*</span></label>
                                    <input id="city" name="city" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="address-line1" required />
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="city">市区町村・番地を入力してください。</p>
                                </div>
                                <div class="flex flex-col sm:col-span-2">
                                    <label for="addr2" class="font-medium">建物名・部屋番号（任意）</label>
                                    <input id="addr2" name="addr2" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="address-line2" />
                                </div>
                            </div>
                        </section>
                    </div>

                    <aside class="md:col-span-1">
                        <div class="md:sticky md:top-[5rem]">
                            <section class="bg-white rounded-xl shadow p-5">
                                <h2 class="text-lg font-bold border-l-4 border-gray-700 pl-2 mb-4">注文サマリー</h2>
                                <dl class="text-sm space-y-2">
                                    <div class="flex items-center justify-between">
                                        <dt>受講区分</dt>
                                        <dd id="enrollTypeLabel" class="font-medium">新規受講</dd>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <dt>小計</dt>
                                        <dd id="subtotal" class="font-medium">¥19,910</dd>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <dt>送料</dt>
                                        <dd id="shipping" class="font-medium">¥0</dd>
                                    </div>
                                    <hr class="my-2">
                                    <div class="flex items-center justify-between text-base">
                                        <dt class="font-bold">合計</dt>
                                        <dd id="grandTotal" class="font-bold">¥19,910</dd>
                                    </div>
                                </dl>

                                <button id="place-order" class="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-3 rounded-xl mt-4">
                                    注文を確定する
                                </button>
                                
                                <div id="form-alert" class="mt-3 text-sm font-medium text-red-600 hidden bg-red-50 p-2 rounded border border-red-200" aria-live="polite">
                                    </div>
                            </section>
                        </div>
                    </aside>
                </div>
            </div>
        </main>

        <div id="privacy-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog" aria-labelledby="privacy-modal-title">
            <div id="privacy-backdrop" class="absolute inset-0 bg-black/30"></div>
            <div class="relative z-10 max-w-2xl mx-auto mt-16 bg-white rounded-2xl shadow-xl border border-gray-200">
                <div class="flex items-center justify-between px-5 py-3 border-b border-gray-100">
                    <h2 id="privacy-modal-title" class="text-base font-semibold">プライバシーポリシー</h2>
                    <button type="button" id="privacy-close" class="p-1 rounded-full hover:bg-gray-100" aria-label="閉じる">
                        <span class="material-symbols-outlined text-gray-500 text-xl">close</span>
                    </button>
                </div>
                <div class="px-5 pt-4 pb-3 max-h-[60vh] overflow-y-auto text-sm leading-relaxed text-gray-700">
                    <p class="mb-3">本サービスでは、お申込みおよび受講に必要な範囲で、お客様の氏名・メールアドレス・住所・電話番号等の個人情報を取得・利用します。</p>
                    <p class="mb-3">取得した個人情報は、受講に関するご連絡、教材発送等の目的のみに利用し、法令に基づく場合を除き、ご本人の同意なく第三者に提供することはありません。</p>
                    <p>（デモ用のダミーテキストです）</p>
                </div>
                <div class="px-5 py-3 border-t border-gray-100 space-y-3">
                    <label class="flex items-start gap-2 text-sm">
                        <input id="modal-agree" type="checkbox" class="mt-1">
                        <span>上記の内容を読み、同意します。</span>
                    </label>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="privacy-cancel" class="px-4 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-50">同意せず閉じる</button>
                        <button type="button" id="privacy-confirm" class="px-4 py-2 rounded-lg bg-blue-600 text-sm text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700" disabled>同意する</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-xs text-gray-500 px-4 py-8 text-center">
            © IEC — プライバシーポリシー / 利用規約
            <div style="height: var(--safe-bottom)"></div>
        </footer>

        <script>
            // ---- Utils & State
            const fmtJPY = (n) => "¥" + n.toLocaleString("ja-JP");
            const clampQty = (v) => Math.max(1, Math.min(999, Number(v) || 1));
            
            // 一度フォーカスが当たった要素のIDを記録するSet
            // 「未入力時に赤くなるのは一度でもフォーカスが当たってから」を実現するため
            const touchedFields = new Set();
            
            // OTP認証完了フラグ
            let isOtpVerified = false;

            // ---- Cart Logic
            function recalcTotals() {
                const list = document.querySelectorAll("#cart-list [data-line-total]");
                let subtotal = 0;
                list.forEach((el) => {
                    const line = Number((el.getAttribute("data-line-total-raw")) || el.textContent.replace(/[^\d]/g, ""));
                    subtotal += line;
                });
                const tax = 0;
                const shipping = 0; 
                const grand = subtotal + tax + shipping;

                document.getElementById("subtotal").textContent = fmtJPY(subtotal);
                document.getElementById("shipping").textContent = fmtJPY(shipping);
                document.getElementById("grandTotal").textContent = fmtJPY(grand);

                // バッジ
                const totalQty = [...document.querySelectorAll("[data-qty]")].reduce((a, i) => a + clampQty(i.value), 0);
                const badge = document.getElementById("cart-badge");
                if (badge) badge.textContent = Math.min(totalQty, 99);
            }

            function bindCart() {
                const root = document.getElementById("cart-list");
                if (!root) return;

                root.addEventListener("click", (e) => {
                    const li = e.target.closest("li");
                    if (!li) return;
                    if (e.target.matches("[data-remove]")) {
                        li.remove();
                        if (!root.querySelector("li")) {
                            root.innerHTML = `<li class="text-gray-500 text-sm">カートに商品はありません。</li>`;
                        }
                        recalcTotals();
                    }
                });
            }

            // ---- Validation System
            const requiredIds = [
                "name_sei", "name_mei", 
                "kana_sei", "kana_mei", 
                "email", "tel", 
                "zip", "pref", "city"
            ];

            function setError(id, hasError) {
                const input = document.getElementById(id);
                if (!input) return;

                // メッセージの表示制御
                const msg = document.querySelector(`[data-error-for="${id}"]`);
                
                // 「エラーがある」かつ「ユーザーが一度触った(touched) or 送信しようとした」場合のみ赤くする
                const shouldShowError = hasError && touchedFields.has(id);

                if (shouldShowError) {
                    input.classList.add("input-error");
                    if(msg) msg.classList.remove("hidden");
                } else {
                    input.classList.remove("input-error");
                    if(msg) msg.classList.add("hidden");
                }
            }

            function getEnrollType() {
                const checked = document.querySelector('input[name="enrollType"]:checked');
                return checked ? checked.value : null;
            }

            function validate(isSubmit = false) {
                let isAllValid = true;

                // 1. 基本必須チェック
                requiredIds.forEach((id) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    
                    // 送信時は全フィールドを「触った」扱いにすることで、未入力箇所を一斉に赤くする
                    if (isSubmit) touchedFields.add(id);

                    const valid = el.checkValidity();
                    setError(id, !valid);
                    if (!valid) isAllValid = false;
                });

                // 2. 受講区分
                const enrollType = getEnrollType();
                if (isSubmit) touchedFields.add("enrollType");
                if (!enrollType) {
                    setError("enrollType", true);
                    isAllValid = false;
                } else {
                    setError("enrollType", false);
                }

                // 3. 再受講番号
                if (enrollType === "re") {
                    const prevNo = document.getElementById("prevEnrollNo");
                    if (isSubmit) touchedFields.add("prevEnrollNo");
                    const has = prevNo.value.trim().length > 0;
                    setError("prevEnrollNo", !has);
                    if (!has) isAllValid = false;
                } else {
                    // 新規の場合はエラー解除
                    setError("prevEnrollNo", false);
                }

                // 4. カタカナチェック
                ["kana_sei", "kana_mei"].forEach(id => {
                    const el = document.getElementById(id);
                    if (isSubmit) touchedFields.add(id);
                    if (el && el.value && !el.value.match(/^[\u30A0-\u30FF\sー－]+$/)) {
                        setError(id, true);
                        isAllValid = false;
                    }
                });

                // 5. 郵便番号形式
                const zip = document.getElementById("zip");
                if (isSubmit) touchedFields.add("zip");
                // 3桁-4桁 or 7桁数字
                if (zip && zip.value && !zip.value.match(/^\d{3}-?\d{4}$/)) { 
                    setError("zip", true); 
                    isAllValid = false; 
                }

                // 6. OTP認証チェック
                const emailEl = document.getElementById("email");
                if (emailEl && emailEl.value && !isOtpVerified) {
                    // メール入力済みなのに認証未完の場合
                    if (isSubmit) {
                        touchedFields.add("emailOtp");
                        setError("emailOtp", true);
                    }
                    isAllValid = false;
                } else {
                    setError("emailOtp", false);
                }

                // 7. 同意チェック
                const agree = document.getElementById("agree");
                if (isSubmit) touchedFields.add("agree");
                if (!agree.checked) {
                    if (isSubmit) setError("agree", true);
                    isAllValid = false;
                } else {
                    setError("agree", false);
                }

                // アラート制御
                const alertBox = document.getElementById("form-alert");
                if (isSubmit && !isAllValid) {
                    alertBox.classList.remove("hidden");
                    alertBox.textContent = "入力内容に不備があります。赤枠の項目を確認してください。";
                } else if (isAllValid) {
                    alertBox.classList.add("hidden");
                }

                return isAllValid;
            }

            // ---- OTP Logic (Demo)
            function bindOtpLogic() {
                const sendBtn = document.getElementById("send-otp");
                const verifyBtn = document.getElementById("verify-otp");
                const emailInput = document.getElementById("email");
                const otpInput = document.getElementById("emailOtp");
                const statusText = document.getElementById("otp-status");
                const demoText = document.getElementById("otp-demo");

                sendBtn.addEventListener("click", () => {
                    touchedFields.add("email");
                    if (!emailInput.value || !emailInput.checkValidity()) {
                        setError("email", true);
                        return;
                    }
                    setError("email", false);
                    alert("認証コードを送信しました。\nデモコード: 123456");
                    otpInput.disabled = false;
                    verifyBtn.disabled = false;
                    otpInput.focus();
                    statusText.textContent = "入力待ち";
                    statusText.className = "text-blue-600 font-bold ml-2";
                    demoText.textContent = "コード: 123456";
                });

                verifyBtn.addEventListener("click", () => {
                    if (otpInput.value === "123456") {
                        isOtpVerified = true;
                        statusText.textContent = "認証完了";
                        statusText.className = "text-green-600 font-bold ml-2";
                        otpInput.disabled = true;
                        verifyBtn.disabled = true;
                        sendBtn.disabled = true;
                        emailInput.readOnly = true;
                        emailInput.classList.add("bg-gray-100", "text-gray-500");
                        setError("emailOtp", false);
                        validate(false);
                    } else {
                        alert("コードが間違っています。");
                        isOtpVerified = false;
                        setError("emailOtp", true);
                    }
                });
            }

            // ---- Input Helpers & Zip Logic
            function bindInputHelpers() {
                // 1. 郵便番号＆住所反映ロジック
                const zipInput = document.getElementById("zip");
                if (zipInput) {
                    zipInput.addEventListener("keyup", (e) => {
                        // 数字以外除去
                        let val = zipInput.value.replace(/[^\d\-]/g, "");
                        
                        // ハイフン自動挿入 (3桁超えたら入れる)
                        const nums = val.replace(/-/g, "");
                        if (nums.length > 3) {
                            val = nums.slice(0, 3) + "-" + nums.slice(3, 7);
                        }
                        zipInput.value = val;

                        // 住所検索実行 (AjaxZip3)
                        // 7桁以上(ハイフン込みで8文字など)になったら検索を試みる
                        if (nums.length >= 7) {
                            // AjaxZip3はグローバル関数。name属性をターゲットにする。
                            // 第1引数:this, 第2:建物名(空), 第3:都道府県name, 第4:市区町村name
                            if (typeof AjaxZip3 !== 'undefined') {
                                AjaxZip3.zip2addr(zipInput, '', 'pref', 'city');
                                
                                // AjaxZip3が値を埋めた瞬間はinputイベントが発火しないことがあるため
                                // 少し待ってからpref/cityをvalid判定させる
                                setTimeout(() => {
                                    touchedFields.add("pref");
                                    touchedFields.add("city");
                                    validate(false);
                                }, 500);
                            }
                        }
                    });
                }

                // 2. 電話番号 (数字のみ)
                const telInput = document.getElementById("tel");
                if (telInput) {
                    telInput.addEventListener("input", (e) => {
                        e.target.value = e.target.value.replace(/[^\d\-]/g, "");
                    });
                }
            }

            // ---- UI Bindings
            function bindEnrollTypeUI() {
                const radios = document.querySelectorAll('input[name="enrollType"]');
                const block = document.getElementById("re-enroll-block");
                const label = document.getElementById("enrollTypeLabel");
                
                const refresh = () => {
                    const t = getEnrollType();
                    if (t === "re") {
                        block.classList.remove("hidden");
                        label.textContent = "再受講";
                    } else {
                        block.classList.add("hidden");
                        label.textContent = "新規受講";
                    }
                };
                radios.forEach(r => r.addEventListener("change", refresh));
                refresh();
            }

            function bindPrivacyModal() {
                const modal = document.getElementById("privacy-modal");
                const openBtn = document.getElementById("open-privacy");
                const closeBtns = [
                    document.getElementById("privacy-close"),
                    document.getElementById("privacy-cancel"),
                    document.getElementById("privacy-backdrop")
                ];
                const agreeCheck = document.getElementById("agree");
                const modalAgree = document.getElementById("modal-agree");
                const confirmBtn = document.getElementById("privacy-confirm");

                openBtn.addEventListener("click", () => modal.classList.remove("hidden"));
                closeBtns.forEach(btn => btn?.addEventListener("click", () => modal.classList.add("hidden")));

                modalAgree.addEventListener("change", () => confirmBtn.disabled = !modalAgree.checked);
                
                confirmBtn.addEventListener("click", () => {
                    if(!modalAgree.checked) return;
                    modal.classList.add("hidden");
                    agreeCheck.checked = true;
                    // 同意チェックがついたので即座にエラー消去確認
                    validate(false);
                });
            }

            // ---- Init
            document.addEventListener("DOMContentLoaded", () => {
                bindCart();
                recalcTotals();
                bindOtpLogic();
                bindInputHelpers();
                bindEnrollTypeUI();
                bindPrivacyModal();

                // 全入力フィールドに対し、Blur(フォーカス外れ)で「触った」とマークする
                document.querySelectorAll("input, select").forEach(el => {
                    // Blur時: touchedに追加して検証
                    el.addEventListener("blur", () => {
                        touchedFields.add(el.id);
                        validate(false);
                    });
                    // Input時: 即座に検証（エラー解消のため）。ただしtouchedには追加しない。
                    el.addEventListener("input", () => {
                        validate(false);
                    });
                });

                // 送信ボタン
                const placeBtn = document.getElementById("place-order");
                placeBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    // 送信時はフラグをtrueにして強制的に全フィールド赤くする
                    if (validate(true)) {
                        alert("注文内容を送信しました。（デモ）");
                    }
                });
            });
        </script>
    </body>
</html>