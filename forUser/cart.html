<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>Course Catalog / Checkout</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajaxzip3.github.io/ajaxzip3.js" charset="UTF-8"></script>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
        <style>
            body { font-family: "游ゴシック体", "Yu Gothic", "游ゴシック", YuGothic, sans-serif; }
            /* iOS Safe Area */
            :root { --safe-bottom: env(safe-area-inset-bottom); }
            /* 数字だけ許容する入力の見た目調整（モバイルで数字キーボードを出しやすく） */
            input[data-numeric] { ime-mode: disabled; }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 border-b border-gray-200/70 bg-white/80 backdrop-blur">
            <div class="max-w-6xl mx-auto h-14 flex items-center px-4">
                <a href="top.html" class="font-bold text-lg tracking-tight">Course Catalog</a>
                <nav class="ml-auto flex items-center gap-1">
                    <a href="cart.html" class="relative p-2 rounded-full hover:bg-gray-100" aria-label="Cart">
                        <span class="material-symbols-outlined align-middle">shopping_cart</span>
                        <span id="cart-badge" class="absolute -top-1 -right-1 text-[10px] h-4 w-4 grid place-items-center rounded-full bg-rose-500 text-white">1</span>
                    </a>
                    <button class="p-2 rounded-full hover:bg-gray-100" aria-label="Profile">
                        <span class="material-symbols-outlined align-middle">account_circle</span>
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main -->
        <main class="flex-1">
            <div class="max-w-6xl w-full mx-auto p-4 md:p-6">
                <!-- Progress -->
                <ol class="flex items-center gap-2 text-sm text-gray-600 mb-4" aria-label="進行状況">
                    <li class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-800 text-white grid place-items-center text-xs font-">1</span><span>カート</span></li>
                    <li class="text-gray-400">—</li>
                    <li class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-800 text-white grid place-items-center text-xs">2</span><span>情報入力</span></li>
                    <li class="text-gray-400">—</li>
                    <li class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-300 text-gray-700 grid place-items-center text-xs">3</span><span>確認・確定</span></li>
                </ol>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 左：フォーム＆カート -->
                    <div class="md:col-span-2 space-y-8">
                        <!-- Cart -->
                        <section class="bg-white rounded-xl shadow p-5">
                            <h2 class="text-xl font-bold border-l-4 border-gray-700 pl-2 mb-4">カート</h2>

                            <ul id="cart-list" class="space-y-4">
                                <!-- Item -->
                                <li class="flex items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium truncate">Excel マクロ＆VBA入門</p>
                                        <p class="text-sm text-gray-500">コースID: EXVBA-101</p>
                                        <button type="button" class="text-sm text-gray-500 hover:text-red-600 underline mt-1" data-remove>削除</button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="inline-flex items-center border rounded-lg hidden">
                                            <button type="button" class="px-2 py-1" data-qty-dec aria-label="数量を減らす">−</button>
                                            <input
                                                class="w-12 text-center outline-none"
                                                type="number" inputmode="numeric" data-numeric
                                                min="1" value="1" data-qty />
                                            <button type="button" class="px-2 py-1" data-qty-inc aria-label="数量を増やす">＋</button>
                                        </div>
                                        <div class="w-24 text-right">
                                            <span class="font-semibold" data-price="19910" data-line-total>¥19,910</span>
                                        </div>
                                    </div>
                                </li>
                            </ul>

                            <div class="mt-4 flex justify-end">
                                <a href="./top.html" class="text-sm text-blue-700 hover:underline">コースを追加する</a>
                            </div>
                        </section>

                        <!-- 基本情報 -->
                        <section class="bg-white rounded-xl shadow p-5">
                            <h2 class="text-xl font-bold border-l-4 border-gray-700 pl-2 mb-4">基本情報</h2>
                            <form id="checkout-form" class="space-y-6" novalidate>
                                <!-- 受講区分 -->
                                <div class="flex flex-col">
                                    <span class="font-medium">受講区分 <span class="text-red-500">*</span></span>
                                    <div class="mt-2 flex flex-wrap gap-4">
                                        <label class="inline-flex items-center gap-2">
                                            <input id="enrollType" type="radio" name="enrollType" value="new" class="accent-blue-600" checked>
                                            <span>新規受講</span>
                                        </label>
                                        <label class="inline-flex items-center gap-2">
                                            <input type="radio" name="enrollType" value="re" class="accent-blue-600">
                                            <span>再受講</span>
                                        </label>
                                    </div>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="enrollType">受講区分を選択してください。</p>
                                </div>

                                <!-- 再受講時のみ表示 -->
                                <div id="re-enroll-block" class="flex flex-col sm:w-1/2 hidden">
                                    <label for="prevEnrollNo" class="font-medium">前回の受講番号 <span class="text-red-500">*</span></label>
                                    <input id="prevEnrollNo" name="prevEnrollNo" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="off" />
                                    <p class="text-sm text-gray-500 mt-1">受講証やメールに記載の「受講番号」を入力してください。</p>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="prevEnrollNo">前回の受講番号を入力してください。</p>
                                </div>

                                <div class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                                    <div class="flex flex-col">
                                        <label for="name" class="font-medium">姓 <span class="text-red-500">*</span></label>
                                        <input id="name" name="name" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="name" required />
                                        <!-- <p class="text-sm text-red-600 mt-1 hidden" data-error-for="name">氏名を入力してください。</p> -->
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="kana" class="font-medium">セイ <span class="text-red-500">*</span></label>
                                        <input id="kana" name="kana" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="" pattern="^[\u30A0-\u30FF\sー－]+$" required />
                                        <p class="text-sm text-gray-500 mt-1">全角カタカナで入力</p>
                                        <!-- <p class="text-sm text-red-600 mt-1 hidden" data-error-for="kana">フリガナ（全角カタカナ）を入力してください。</p> -->
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="name" class="font-medium">名 <span class="text-red-500">*</span></label>
                                        <input id="name" name="name" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="name" required />
                                        <!-- <p class="text-sm text-red-600 mt-1 hidden" data-error-for="name">氏名を入力してください。</p> -->
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="kana" class="font-medium">メイ <span class="text-red-500">*</span></label>
                                        <input id="kana" name="kana" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="" pattern="^[\u30A0-\u30FF\sー－]+$" required />
                                        <p class="text-sm text-gray-500 mt-1">全角カタカナで入力</p>
                                        <!-- <p class="text-sm text-red-600 mt-1 hidden" data-error-for="kana">フリガナ（全角カタカナ）を入力してください。</p> -->
                                    </div>
                                </div>

                               <!-- メール＋OTP -->
                                <div class="flex flex-col space-y-2">
                                    <div class="flex flex-col">
                                        <label for="email" class="font-medium">メールアドレス <span class="text-red-500">*</span></label>
                                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-1">
                                            <input id="email" name="email" type="email" class="border rounded-lg p-2 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="email" required />
                                            <button
                                                type="button"
                                                id="send-otp"
                                                class="px-3 py-2 text-sm rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 whitespace-nowrap"
                                            >
                                                認証コードを送信
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">入力したメールアドレス宛にワンタイム認証コードを送信します（デモ）。</p>
                                        <p class="text-sm text-red-600 mt-1 hidden" data-error-for="email">有効なメールアドレスを入力してください。</p>
                                    </div>

                                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 flex-1">
                                            <input
                                                id="emailOtp"
                                                name="emailOtp"
                                                type="text"
                                                class="border rounded-lg p-2 flex-1 disabled:bg-gray-100 disabled:text-gray-400"
                                                placeholder="6桁の認証コード"
                                                maxlength="6"
                                                inputmode="numeric"
                                                data-numeric
                                                disabled
                                            />
                                            <button
                                                type="button"
                                                id="verify-otp"
                                                class="px-3 py-2 text-sm rounded-lg border border-gray-400 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                                disabled
                                            >
                                                認証
                                            </button>
                                        </div>
                                    </div>

                                    <div class="text-xs mt-1">
                                        <span id="otp-status" class="text-gray-500">認証コード未送信</span>
                                        <!-- デモ用にコード表示 -->
                                        <span id="otp-demo" class="ml-2 text-[11px] text-gray-400"></span>
                                    </div>

                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="emailOtp">メールアドレスの認証が完了していません。</p>
                                </div>

                                <div class="flex flex-col sm:w-1/2">
                                    <label for="tel" class="font-medium">電話番号 <span class="text-red-500">*</span></label>
                                    <input id="tel" name="tel" type="tel" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" inputmode="numeric" data-numeric autocomplete="tel" placeholder="09012345678" pattern="^[0-9\-]+$" required />
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="tel">数字のみで入力してください。</p>
                                </div>
                                <!-- プライバシーポリシー同意（モーダル起点） -->
                                <div class="pt-2">
                                <label class="inline-flex items-start gap-2">
                                    <input id="agree" type="checkbox" class="mt-1" disabled>
                                    <span class="text-sm text-gray-700">
                                    <button
                                        type="button"
                                        id="open-privacy"
                                        class="underline text-blue-700 hover:text-blue-900"
                                    >
                                        プライバシーポリシー
                                    </button>
                                    を確認のうえ、内容に同意します
                                    </span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">
                                    プライバシーポリシーを開き、「同意する」ボタンを押すとチェックが付きます。
                                </p>
                                </div>
                            </form>
                        </section>

                        <!-- Shipping -->
                        <section class="bg-white rounded-xl shadow p-5">
                            <h2 class="text-xl font-bold border-l-4 border-gray-700 pl-2 mb-4">配送先</h2>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="flex flex-col">
                                    <label for="zip" class="font-medium">郵便番号 <span class="text-red-500">*</span></label>
                                    <input id="zip" name="zip" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" inputmode="numeric" data-numeric placeholder="123-4567" pattern="^\d{3}-?\d{4}$" required onKeyUp="AjaxZip3.zip2addr(this, '', 'pref', 'city');" />
                                    <p class="text-sm text-gray-500 mt-1">半角数字（自動で 123-4567 形式になります）</p>
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="zip">郵便番号を正しく入力してください。</p>
                                </div>
                                <div class="flex flex-col">
                                    <label for="pref" class="font-medium">都道府県 <span class="text-red-500">*</span></label>
                                    <input id="pref" name="pref" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="address-level1" required />
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="pref">都道府県を入力してください。</p>
                                </div>
                                <div class="flex flex-col sm:col-span-2">
                                    <label for="city" class="font-medium">市区町村・番地 <span class="text-red-500">*</span></label>
                                    <input id="city" name="city" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="address-line1" required />
                                    <p class="text-sm text-red-600 mt-1 hidden" data-error-for="city">市区町村・番地を入力してください。</p>
                                </div>
                                <div class="flex flex-col sm:col-span-2">
                                    <label for="addr2" class="font-medium">建物名・部屋番号（任意）</label>
                                    <input id="addr2" name="addr2" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="address-line2" />
                                </div>
                            </div>
                        </section>

                        <div class="p-4 bg-blue-100 border-blue-500 border border-dashed rounded-lg text-blue-500">
                            この画面は募集サイト作成時の「申込フォーム」機能で設定した項目と対応する想定。
                        </div>
                    </div>

                    <!-- 右：サマリー -->
                    <aside class="md:col-span-1">
                        <div class="md:sticky md:top-[5rem]">
                            <section class="bg-white rounded-xl shadow p-5">
                                <h2 class="text-lg font-bold border-l-4 border-gray-700 pl-2 mb-4">注文サマリー</h2>
                                <dl class="text-sm space-y-2">
                                    <div class="flex items-center justify-between">
                                        <dt>受講区分</dt>
                                        <dd id="enrollTypeLabel" class="font-medium">新規受講</dd>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <dt>小計</dt>
                                        <dd id="subtotal" class="font-medium">¥19,910</dd>
                                    </div>
                                    <!-- <div class="flex items-center justify-between">
                                        <dt>消費税（10%）</dt>
                                        <dd id="tax" class="font-medium">¥1,810</dd>
                                    </div> -->
                                    <div class="flex items-center justify-between">
                                        <dt>送料</dt>
                                        <dd id="shipping" class="font-medium">¥0</dd>
                                    </div>
                                    <hr class="my-2">
                                    <div class="flex items-center justify-between text-base">
                                        <dt class="font-bold">合計</dt>
                                        <dd id="grandTotal" class="font-bold">¥19,910</dd>
                                    </div>
                                </dl>

                                <button
                                    id="place-order"
                                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-3 rounded-xl mt-4"
                                    disabled
                                >
                                    注文を確定する
                                </button>
                                <p class="text-xs text-gray-500 mt-2">同意チェックと必須項目の入力が完了すると、有効になります。</p>
                                <div id="form-alert" class="mt-3 text-sm text-red-600 hidden" aria-live="polite"></div>
                            </section>
                        </div>
                    </aside>
                </div>
            </div>
        </main>

        <!-- Privacy Policy Modal -->
        <div
        id="privacy-modal"
        class="fixed inset-0 z-50 hidden"
        aria-modal="true"
        role="dialog"
        aria-labelledby="privacy-modal-title"
        >
            <!-- backdrop -->
            <div id="privacy-backdrop" class="absolute inset-0 bg-black/30"></div>

            <!-- dialog -->
            <div class="relative z-10 max-w-2xl mx-auto mt-16 bg-white rounded-2xl shadow-xl border border-gray-200">
                <div class="flex items-center justify-between px-5 py-3 border-b border-gray-100">
                    <h2 id="privacy-modal-title" class="text-base font-semibold">プライバシーポリシー</h2>
                    <button
                        type="button"
                        id="privacy-close"
                        class="p-1 rounded-full hover:bg-gray-100"
                        aria-label="閉じる"
                    >
                        <span class="material-symbols-outlined text-gray-500 text-xl">close</span>
                    </button>
                </div>

            <div class="px-5 pt-4 pb-3 max-h-[60vh] overflow-y-auto text-sm leading-relaxed text-gray-700">
                <!-- ここに実際のプライバシーポリシー本文を入れる想定。以下ダミー。 -->
                <p class="mb-3">
                    本サービスでは、お申込みおよび受講に必要な範囲で、お客様の氏名・メールアドレス・住所・電話番号等の個人情報を取得・利用します。
                </p>
                <p class="mb-3">
                    取得した個人情報は、受講に関するご連絡、教材発送、成績・修了管理、各種ご案内の送付等の目的のみに利用し、法令に基づく場合を除き、ご本人の同意なく第三者に提供することはありません。
                </p>
                <p class="mb-3">
                    また、個人情報の漏えい・紛失・改ざん等を防止するため、適切な安全管理措置を講じます。詳細な取扱いについては、当社Webサイトに掲載のプライバシーポリシー全文をご確認ください。
                </p>
            </div>

            <div class="px-5 py-3 border-t border-gray-100 space-y-3">
            <label class="flex items-start gap-2 text-sm">
                <input id="modal-agree" type="checkbox" class="mt-1">
                <span>上記の内容を読み、同意します。</span>
            </label>
            <div class="flex justify-end gap-2">
                <button
                type="button"
                id="privacy-cancel"
                class="px-4 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-50"
                >
                同意せず閉じる
                </button>
                <button
                type="button"
                id="privacy-confirm"
                class="px-4 py-2 rounded-lg bg-blue-600 text-sm text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700"
                disabled
                >
                同意する
                </button>
            </div>
            </div>
        </div>
        </div>

        <!-- Footer -->
        <footer class="text-xs text-gray-500 px-4 py-8 text-center">
            © IEC — プライバシーポリシー / 利用規約
            <div style="height: var(--safe-bottom)"></div>
        </footer>

        <!-- Scripts -->
        <script>
            // ---- Utils
            const fmtJPY = (n) => "¥" + n.toLocaleString("ja-JP");
            const clampQty = (v) => Math.max(1, Math.min(999, Number(v) || 1));

            // ---- カート計算
            function recalcTotals() {
                const list = document.querySelectorAll("#cart-list [data-line-total]");
                let subtotal = 0;
                list.forEach((el) => {
                    const line = Number((el.getAttribute("data-line-total-raw")) || el.textContent.replace(/[^\d]/g, ""));
                    subtotal += line;
                });
                const tax = 0;
                const shipping = 0; // 送料ロジックを後で差し替え
                const grand = subtotal + tax + shipping;

                document.getElementById("subtotal").textContent = fmtJPY(subtotal);
                const taxEl = document.getElementById("tax");
                if (taxEl) taxEl.textContent = fmtJPY(tax);
                document.getElementById("shipping").textContent = fmtJPY(shipping);
                document.getElementById("grandTotal").textContent = fmtJPY(grand);

                // バッジ
                const totalQty = [...document.querySelectorAll("[data-qty]")].reduce((a, i) => a + clampQty(i.value), 0);
                const badge = document.getElementById("cart-badge");
                if (badge) badge.textContent = Math.min(totalQty, 99);
            }

            function bindCart() {
                const root = document.getElementById("cart-list");
                root.addEventListener("click", (e) => {
                    const li = e.target.closest("li");
                    if (!li) return;

                    // 数量増減
                    if (e.target.matches("[data-qty-inc]") || e.target.matches("[data-qty-dec]")) {
                        const input = li.querySelector("[data-qty]");
                        const base = Number(li.querySelector("[data-price]").getAttribute("data-price"));
                        let next = clampQty(input.value) + (e.target.matches("[data-qty-inc]") ? 1 : -1);
                        next = clampQty(next);
                        input.value = next;

                        const lineTotal = base * next;
                        const lineEl = li.querySelector("[data-line-total]");
                        lineEl.textContent = fmtJPY(lineTotal);
                        lineEl.setAttribute("data-line-total-raw", String(lineTotal));
                        recalcTotals();
                    }

                    // 削除
                    if (e.target.matches("[data-remove]")) {
                        li.remove();
                        if (!root.querySelector("li")) {
                            root.innerHTML = `<li class="text-gray-500 text-sm">カートに商品はありません。</li>`;
                        }
                        recalcTotals();
                    }
                });

                root.addEventListener("input", (e) => {
                    if (e.target.matches("[data-qty]")) {
                        const li = e.target.closest("li");
                        const base = Number(li.querySelector("[data-price]").getAttribute("data-price"));
                        const next = clampQty(e.target.value);
                        e.target.value = next;
                        const lineTotal = base * next;
                        const lineEl = li.querySelector("[data-line-total]");
                        lineEl.textContent = fmtJPY(lineTotal);
                        lineEl.setAttribute("data-line-total-raw", String(lineTotal));
                        recalcTotals();
                    }
                });
            }

            // ---- 入力補助
            function autoHyphenZip(e) {
                let v = e.target.value.replace(/[^\d]/g, "");
                if (v.length > 3) v = v.slice(0, 3) + "-" + v.slice(3, 7);
                e.target.value = v.slice(0, 8);
            }
            function digitsOnly(e) {
                e.target.value = e.target.value.replace(/[^\d\-]/g, "");
            }

            // ---- 検証
            const form = document.getElementById("checkout-form");
            const placeBtn = document.getElementById("place-order");
            const alertBox = document.getElementById("form-alert");

            function setError(id, show) {
                const input = document.getElementById(id);
                const msg = document.querySelector(`[data-error-for="${id}"]`);
                if (!msg || !input) return;
                msg.classList.toggle("hidden", !show);
                input.setAttribute("aria-invalid", show ? "true" : "false");
            }

            function getEnrollType() {
                const checked = document.querySelector('input[name="enrollType"]:checked');
                return checked ? checked.value : null;
            }

            function validate() {
                let ok = true;
                // 必須
                ["name","kana","email","tel","zip","pref","city"].forEach((id) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const valid = el.checkValidity();
                    setError(id, !valid);
                    if (!valid) ok = false;
                });

                // 受講区分
                const enrollType = getEnrollType();
                if (!enrollType) {
                    setError("enrollType", true);
                    ok = false;
                } else {
                    setError("enrollType", false);
                }

                // 再受講時：前回受講番号必須
                const prevNo = document.getElementById("prevEnrollNo");
                if (enrollType === "re") {
                    const has = prevNo.value.trim().length > 0;
                    setError("prevEnrollNo", !has);
                    if (!has) ok = false;
                } else {
                    setError("prevEnrollNo", false);
                }

                // カタカナ
                const kana = document.getElementById("kana");
                if (kana.value && !kana.value.match(/^[\u30A0-\u30FF\sー－]+$/)) { setError("kana", true); ok = false; }

                // email一致
                //const e1 = document.getElementById("email").value.trim();
                //const e2 = document.getElementById("email2").value.trim();
                //if (e1 !== e2) { setError("email2", true); ok = false; } else { setError("email2", false); }

                // tel数字
                const tel = document.getElementById("tel");
                if (tel.value && !tel.value.match(/^[0-9\-]+$/)) { setError("tel", true); ok = false; }

                // zip桁
                const zip = document.getElementById("zip");
                if (zip.value && !zip.value.match(/^\d{3}-?\d{4}$/)) { setError("zip", true); ok = false; }

                // 同意
                const agree = document.getElementById("agree").checked;
                if (!agree) ok = false;

                placeBtn.disabled = !ok;
                alertBox.classList.toggle("hidden", ok);
                if (!ok) {
                    alertBox.textContent = "入力内容を確認してください（必須項目、フォーマット、同意チェックなど）。";
                }
                return ok;
            }

            // ---- 同じ住所にコピー（現状 sameAsBuyer がない場合は何もしない）
            function bindSameAsBuyer() {
                const cb = document.getElementById("sameAsBuyer");
                if (!cb) return;
                cb.addEventListener("change", () => {
                    if (!cb.checked) return;
                    const tel = document.getElementById("tel").value;
                    if (tel) document.getElementById("telShip").value = tel;
                });
            }

            // ---- 受講区分の表示・サマリー連動
            function bindEnrollTypeUI() {
                const radios = document.querySelectorAll('input[name="enrollType"]');
                const block = document.getElementById("re-enroll-block");
                const label = document.getElementById("enrollTypeLabel");

                const refresh = () => {
                    const t = getEnrollType();
                    if (t === "re") {
                        block.classList.remove("hidden");
                        if (label) label.textContent = "再受講";
                    } else {
                        block.classList.add("hidden");
                        if (label) label.textContent = "新規受講";
                    }
                    validate();
                };

                radios.forEach(r => r.addEventListener("change", refresh));
                refresh();
            }

            // ---- Privacy Modal
            function bindPrivacyModal() {
                const modal = document.getElementById("privacy-modal");
                const agreeCheckbox = document.getElementById("agree");
                const openBtn = document.getElementById("open-privacy");
                const closeBtn = document.getElementById("privacy-close");
                const cancelBtn = document.getElementById("privacy-cancel");
                const confirmBtn = document.getElementById("privacy-confirm");
                const modalAgree = document.getElementById("modal-agree");
                const backdrop = document.getElementById("privacy-backdrop");

                if (!modal || !agreeCheckbox || !openBtn) return;

                const close = () => {
                modal.classList.add("hidden");
                modalAgree.checked = false;
                confirmBtn.disabled = true;
                };

                openBtn.addEventListener("click", () => {
                    modal.classList.remove("hidden");
                });

                closeBtn.addEventListener("click", close);
                cancelBtn.addEventListener("click", close);
                backdrop.addEventListener("click", close);

                modalAgree.addEventListener("change", () => {
                    confirmBtn.disabled = !modalAgree.checked;
                });

                confirmBtn.addEventListener("click", () => {
                    if (!modalAgree.checked) return;
                    agreeCheckbox.checked = true;
                    close();
                    validate();
                });
            }

            // ---- 送信
            placeBtn.addEventListener("click", (e) => {
                e.preventDefault();
                if (!validate()) return;
                // 実運用ではここでPOST/Fetch
                alertBox.classList.remove("hidden");
                alertBox.classList.remove("text-red-600");
                alertBox.classList.add("text-green-700");
                alertBox.textContent = "注文内容を送信しました（デモ）。";
            });

            // ---- 初期化
            document.addEventListener("DOMContentLoaded", () => {
                bindCart();
                recalcTotals();

                // 入力イベントで都度バリデーション
                document.querySelectorAll("input, select, textarea").forEach((el) => {
                    el.addEventListener("input", () => validate());
                    el.addEventListener("blur", () => validate());
                });

                // 郵便番号・電話の整形
                document.getElementById("zip").addEventListener("input", autoHyphenZip);
                ["tel","telShip"].forEach(id => {
                    const el = document.getElementById(id);
                    el && el.addEventListener("input", digitsOnly);
                });

                bindSameAsBuyer();
                bindEnrollTypeUI();
                bindPrivacyModal();
            });
        </script>
    </body>
</html>
