<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>Course Catalog</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="js/header.js" defer></script>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
        <style>
            body {
                font-family: "Inter", "Noto Sans JP", system-ui, -apple-system, Segoe UI, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            html { scroll-behavior: smooth; }
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            .glass { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.6); }
            /* ハートのアニメーション用 */
            @keyframes heart-pop {
                0% { transform: scale(1); }
                50% { transform: scale(1.4); }
                100% { transform: scale(1); }
            }
            .heart-active .material-symbols-outlined {
                animation: heart-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                color: #ef4444 !important; /* text-rose-500 */
                font-variation-settings: 'FILL' 1; /* 塗りつぶし */
            }
            /* デフォルトのアイコン設定（塗りつぶしなし） */
            .material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
                transition: color 0.3s ease, font-variation-settings 0.3s ease;
            }
            /* Range Slider */
            .range-vis {
                -webkit-appearance: none; appearance: none;
                position: absolute; left: 0; right: 0; top: 0; bottom: 0; width: 100%;
                background: transparent; pointer-events: auto;
            }
            .range-vis::-webkit-slider-thumb {
                -webkit-appearance: none; appearance: none;
                height: 18px; width: 18px; border-radius: 9999px;
                background: white; border: 2px solid rgb(2,132,199); /* sky-600 */
                box-shadow: 0 1px 2px rgba(0,0,0,.12);
                cursor: pointer;
            }
            .range-vis::-moz-range-thumb {
                height: 18px; width: 18px; border-radius: 9999px;
                background: white; border: 2px solid rgb(2,132,199);
                box-shadow: 0 1px 2px rgba(0,0,0,.12);
                cursor: pointer;
            }
        </style>
    </head>
    <body class="bg-gray-100 text-gray-800">
        <div id="global-header" class="sticky top-0 z-[60] w-full"></div>

        <section class="relative">
            <div class="mx-auto max-w-6xl px-4">
                <div class="relative mt-6">
                    <div class="pointer-events-none absolute inset-y-0 left-0 w-16 bg-gradient-to-r from-gray-50 to-transparent z-10"></div>
                    <div class="pointer-events-none absolute inset-y-0 right-0 w-16 bg-gradient-to-l from-gray-50 to-transparent z-10"></div>

                    <div id="hero" class="no-scrollbar flex snap-x snap-mandatory gap-4 overflow-x-auto scroll-smooth pb-2">
                    <a href="guidelines.html" class="group relative snap-start shrink-0 basis-[85%] md:basis-[70%] lg:basis-[60%] rounded-2xl overflow-hidden shadow-lg">
                        <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 via-sky-500 to-emerald-500"></div>
                        <div class="relative h-64 md:h-80 grid place-items-center text-white text-center">
                        <div class="px-6">
                            <div class="text-sm/5 md:text-base/6 opacity-90">2026年度 自己啓発制度</div>
                            <h2 class="mt-2 text-3xl md:text-5xl font-black tracking-tight drop-shadow">募集要項</h2>
                            <p class="mt-3 text-white/90">申込前に必ずご確認ください</p>
                            <span class="inline-flex items-center gap-1 rounded-full bg-white/20 px-3 py-1 text-sm mt-4">
                            <span class="material-symbols-outlined text-base">open_in_new</span> 詳細を見る
                            </span>
                        </div>
                        </div>
                    </a>
                    <a href="../animal_type/index.html" class="relative snap-start shrink-0 basis-[85%] md:basis-[70%] lg:basis-[60%] rounded-2xl overflow-hidden shadow-lg">
                        <img src="image/start.png" alt="Trend" class="h-64 md:h-80 w-full object-cover" loading="lazy" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                        <div class="absolute bottom-3 left-4 text-white font-medium"></div>
                    </a>
                    <a href="#" class="relative snap-start shrink-0 basis-[85%] md:basis-[70%] lg:basis-[60%] rounded-2xl overflow-hidden shadow-lg">
                        <img src="../img/slide1.webp" alt="Learning slide" class="h-64 md:h-80 w-full object-cover" loading="lazy" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                        <div class="absolute bottom-3 left-4 text-white font-medium">絶妙なライン、これってセクハラ？</div>
                    </a>
                    <a href="#" class="relative snap-start shrink-0 basis-[85%] md:basis-[70%] lg:basis-[60%] rounded-2xl overflow-hidden shadow-lg">
                        <img src="../img/slide2.webp" alt="Trend" class="h-64 md:h-80 w-full object-cover" loading="lazy" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                        <div class="absolute bottom-3 left-4 text-white font-medium">BitコインでFIREだ！</div>
                    </a>
                    <div class="relative snap-start shrink-0 basis-[85%] md:basis-[70%] lg:basis-[60%] rounded-2xl overflow-hidden shadow-lg bg-gradient-to-br from-amber-200 via-pink-200 to-cyan-200 h-64 md:h-80 grid place-items-center">
                        <div class="text-center">
                        <div class="text-2xl md:text-3xl font-bold">社内おすすめ</div>
                        <div class="text-gray-700 mt-1">新着コースをチェック</div>
                        </div>
                    </div>
                    </div>

                    <button data-prev class="absolute left-1 top-1/2 -translate-y-1/2 rounded-full bg-white/80 hover:bg-white p-2 shadow flex z-20">
                        <span class="material-symbols-outlined">chevron_left</span>
                    </button>
                    <button data-next class="absolute right-1 top-1/2 -translate-y-1/2 rounded-full bg-white/80 hover:bg-white p-2 shadow flex z-20">
                        <span class="material-symbols-outlined">chevron_right</span>
                    </button>
                </div>
            </div>
        </section>
        <div class="mx-auto max-w-6xl px-4 mt-3 flex items-center justify-center gap-3 text-xs text-gray-600" id="hero-indicator">
            <div class="flex items-center gap-2" id="hero-dots"></div>
        </div>

        <div class="sticky top-14 z-30 bg-gray-100/90 backdrop-blur border-b border-gray-200/50 py-3 mt-6 transition-all">
            <section class="mx-auto max-w-6xl px-4">
                <div class="flex flex-col md:flex-row md:items-center justify-center gap-3">
                    <div class="flex items-center w-full md:w-auto lg:max-w-3xl flex-1 rounded-full bg-white shadow-sm border border-gray-200 pl-3 focus-within:ring-2 ring-sky-500 focus-within:border-sky-500 transition-colors">
                        <span class="material-symbols-outlined text-gray-400 mr-1">search</span>
                        <input type="search" id="search-input" placeholder="コース名やキーワードで検索" class="bg-white flex-1 py-2.5 px-1 rounded-full focus:outline-none text-sm" aria-label="コース検索" />
                        
                        <button id="btn-sort" class="flex m-1.5 rounded-full p-1.5 hover:bg-gray-100 text-gray-500 relative" aria-haspopup="true" aria-expanded="false" title="並び替え">
                            <span class="material-symbols-outlined text-[20px]">swap_vert</span>
                        </button>

                        <button id="btn-filter" class="flex m-1.5 rounded-full p-1.5 hover:bg-gray-100 text-gray-500" aria-haspopup="dialog" aria-controls="filter-dialog" aria-expanded="false" title="フィルタ">
                            <span class="material-symbols-outlined text-[20px]">tune</span>
                        </button>
                    </div>

                    <div class="hidden md:flex bg-white rounded-full shadow-sm border border-gray-200 p-1 gap-1">
                        <button id="view-toggle-grid" class="flex p-2 rounded-full bg-sky-100 text-sky-600 shadow-inner transition" aria-label="グリッド表示">
                            <span class="material-symbols-outlined text-[20px]">grid_view</span>
                        </button>
                        <button id="view-toggle-list" class="flex p-2 rounded-full text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition" aria-label="リスト表示">
                            <span class="material-symbols-outlined text-[20px]">view_list</span>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <section class="mx-auto max-w-6xl px-4 mt-8 mb-16" aria-label="コース一覧">
            <div id="course-panel" role="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 transition-all duration-300">
            </div>
            <div id="loading-sentinel" class="mt-12 flex justify-center py-4 opacity-0 transition-opacity duration-300">
                <div class="flex flex-col items-center gap-2">
                    <div class="h-8 w-8 animate-spin rounded-full border-4 border-slate-200 border-t-sky-500"></div>
                    <span class="text-xs font-bold text-slate-400 tracking-wider">LOADING...</span>
                </div>
            </div>
        </section>
        
        <footer class="border-t border-gray-200/70 bg-white">
            <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-gray-500 flex flex-wrap items-center justify-between gap-3">
            <div>© IEC — プライバシーポリシー / 利用規約</div>
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-base">help</span>
                <a href="#" class="hover:underline">ヘルプ</a>
            </div>
            </div>
        </footer>

        <div id="sort-dialog" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
            <div id="sort-backdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-200"></div>
            <div class="pointer-events-none absolute inset-0 flex items-end justify-center md:items-center">
                <div id="sort-panel" class="pointer-events-auto w-full md:w-80 bg-white md:rounded-2xl rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-200 ease-out overflow-hidden m-0 md:m-4">
                    <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                        <h3 class="font-bold text-gray-800">並び替え</h3>
                        <button id="sort-close" class="p-1 rounded-full hover:bg-gray-200 text-gray-500 transition">
                            <span class="material-symbols-outlined text-[20px]">close</span>
                        </button>
                    </div>
                    <div class="p-2 space-y-1">
                        <button class="sort-option w-full text-left px-4 py-3 rounded-xl hover:bg-sky-50 text-sm font-medium text-sky-700 flex items-center justify-between group" data-val="recommend">
                            <span>受講期間が短い順</span>
                            <span class="material-symbols-outlined text-sky-600 text-[20px]">check</span>
                        </button>
                        <button class="sort-option w-full text-left px-4 py-3 rounded-xl hover:bg-sky-50 text-sm font-medium text-gray-600 hover:text-sky-700 flex items-center justify-between group" data-val="new">
                            <span>受講期間が長い順</span>
                            <span class="material-symbols-outlined text-sky-600 text-[20px] opacity-0 group-hover:opacity-50">check</span>
                        </button>
                        <button class="sort-option w-full text-left px-4 py-3 rounded-xl hover:bg-sky-50 text-sm font-medium text-gray-600 hover:text-sky-700 flex items-center justify-between group" data-val="price_asc">
                            <span>価格が安い順</span>
                            <span class="material-symbols-outlined text-sky-600 text-[20px] opacity-0 group-hover:opacity-50">check</span>
                        </button>
                        <button class="sort-option w-full text-left px-4 py-3 rounded-xl hover:bg-sky-50 text-sm font-medium text-gray-600 hover:text-sky-700 flex items-center justify-between group" data-val="price_desc">
                            <span>価格が高い順</span>
                            <span class="material-symbols-outlined text-sky-600 text-[20px] opacity-0 group-hover:opacity-50">check</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="filter-dialog" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="filter-title">
            <div id="filter-backdrop" class="absolute inset-0 bg-black/40 backdrop-blur opacity-0 transition-opacity duration-200"></div>
            <div class="pointer-events-none flex items-end md:items-center justify-center min-h-full">
                <div id="filter-panel" class="pointer-events-auto relative w-full md:w-[640px] max-w-2xl md:rounded-3xl rounded-t-3xl bg-white shadow-2xl translate-y-6 md:translate-y-0 md:scale-95 opacity-0 transition-all duration-200 ease-out md:my-16">
                    <div class="px-6 py-5 border-b border-gray-100 flex items-center gap-3">
                        <span class="material-symbols-outlined text-sky-600">tune</span>
                        <div class="mr-auto">
                        <h2 id="filter-title" class="text-lg font-semibold leading-tight">フィルタ</h2>
                        <p class="text-sm text-gray-500">条件を選んでコースを絞り込み</p>
                        </div>
                        <button id="filter-close" class="p-2 rounded-full hover:bg-gray-100 flex" aria-label="Close">
                        <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="px-6 py-5 space-y-6">
                        <div>
                        <label class="block text-sm text-gray-600 mb-2">キーワード</label>
                        <div class="flex items-center rounded-xl border border-gray-200 focus-within:ring-2 focus-within:ring-sky-500 bg-white px-3">
                            <span class="material-symbols-outlined text-gray-400 mr-1">search</span>
                            <input id="filter-keyword" type="search" class="bg-white w-full rounded-xl py-2.5 px-2 outline-none" placeholder="例）マネジメント / VBA など" />
                        </div>
                        </div>
                        <div>
                        <label class="block text-sm text-gray-600 mb-2">タグ</label>
                        <div class="flex flex-wrap gap-2">
                            <button class="rounded-full px-3 py-1.5 text-sm border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 transition" data-chip aria-pressed="false">生成AI</button>
                            <button class="rounded-full px-3 py-1.5 text-sm border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 transition" data-chip aria-pressed="false">マネジメント</button>
                            <button class="rounded-full px-3 py-1.5 text-sm border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 transition" data-chip aria-pressed="false">基礎</button>
                            <button class="rounded-full px-3 py-1.5 text-sm border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 transition" data-chip aria-pressed="false">資格</button>
                            <button class="rounded-full px-3 py-1.5 text-sm border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 transition" data-chip aria-pressed="false">推奨</button>
                        </div>
                        </div>
                        <div>
                        <label class="block text-sm text-gray-600 mb-2">受講期間</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center px-3 py-1.5 rounded-full border border-gray-200 bg-white text-gray-700 text-sm transition">
                                <input type="checkbox" class="peer hidden">
                                <span class="pill-ui">1ヶ月</span>
                                </label>
                                <label class="inline-flex items-center px-3 py-1.5 rounded-full border border-gray-200 bg-white text-gray-700 text-sm transition">
                                <input type="checkbox" class="peer hidden">
                                <span class="pill-ui">3ヶ月</span>
                                </label>
                                <label class="inline-flex items-center px-3 py-1.5 rounded-full border border-gray-200 bg-white text-gray-700 text-sm transition">
                                <input type="checkbox" class="peer hidden">
                                <span class="pill-ui">6ヶ月</span>
                                </label>
                            </div>
                        </div>
                        <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm text-gray-600">受講料レンジ</label>
                            <div class="text-sm text-gray-500"><span id="price-min">0</span> 円 〜 <span id="price-max">30,000</span> 円</div>
                        </div>
                        <div class="relative h-10">
                            <div class="absolute left-0 right-0 top-1/2 -translate-y-1/2 h-1.5 bg-gray-200 rounded-full"></div>
                            <div id="price-fill" class="absolute top-1/2 -translate-y-1/2 h-1.5 bg-gradient-to-r from-sky-500 to-indigo-500 rounded-full"></div>
                            <input id="range-min" type="range" min="0" max="50000" value="0" class="range-vis">
                            <input id="range-max" type="range" min="0" max="50000" value="30000" class="range-vis">
                        </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 border-t border-gray-100 bg-white md:rounded-b-3xl rounded-b-3xl flex items-center justify-between gap-3">
                        <button id="filter-reset" class="text-sm text-gray-600 hover:text-gray-800 underline">リセット</button>
                        <div class="flex items-center gap-2">
                            <button class="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50">キャンセル</button>
                            <button id="filter-apply" class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 shadow-sm">適用</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="deadline-banner" class="fixed inset-x-3 bottom-3 md:inset-x-auto md:right-6 md:bottom-6 z-40 md:z-50">
            <div class="max-w-xl md:max-w-sm mx-auto md:mx-0 rounded-2xl shadow-xl border border-sky-100 bg-white/95 backdrop-blur px-4 py-3 flex items-start gap-3">
                <div class="mt-0.5 flex h-8 w-8 flex-none items-center justify-center rounded-full bg-sky-100 text-sky-700">
                    <span class="material-symbols-outlined text-[20px]">event_upcoming</span>
                </div>
                <div class="min-w-0  flex-1 text-xs md:text-sm text-gray-800">
                    <p class="font-semibold text-gray-900 text-sm md:text-base">
                        6月1日開講の<br>申込締切は<span class="font-bold text-sky-700 text-2xl">5月15日</span>です。
                    </p>
                    <p>お申込みはお早めに！</p>
                </div>
                <button id="deadline-banner-close" type="button" class="ml-1 flex h-7 w-7 flex-none items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition" aria-label="このお知らせを閉じる">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            </div>
        </div>

    </body>
</html>

<script src="js/course-data.js"></script>

<script>
    // ==========================================
    // 1. Global State & Settings
    // ==========================================
    let currentOffset = 0;     // 現在何件表示しているか
    const BATCH_SIZE = 6;      // 一度に読み込む件数
    let isListMode = false;    // 現在の表示モード (Grid=false, List=true)
    let isLoading = false;     // 読み込み中フラグ

    // ==========================================
    // 2. Infinite Scroll & Rendering Logic
    // ==========================================
    function loadMoreCourses() {
        const container = document.getElementById('course-panel');
        const sentinel = document.getElementById('loading-sentinel');
        
        if (!container || isLoading) return;
        if (typeof courseList === 'undefined') {
            console.error('Error: courseList is undefined.');
            return;
        }
        
        // 全件表示済みならローディングを隠して終了
        if (currentOffset >= courseList.length) {
            sentinel.classList.add('hidden');
            return;
        }

        isLoading = true;
        sentinel.classList.remove('opacity-0');

        setTimeout(() => {
            // ★重要: 現在の offset から BATCH_SIZE 分だけ取得
            const nextBatch = courseList.slice(currentOffset, currentOffset + BATCH_SIZE);
            let html = '';

            nextBatch.forEach(course => {
                // --- データ準備 (タグ生成など) ---
                const tagsHtml = course.tags.map(tag => 
                    `<span class="px-2.5 py-0.5 rounded-md ${tag.color} text-white text-[11px] font-bold tracking-wide">${tag.text}</span>`
                ).join('');

                let favImgSrc = (course.thumbnail.type === "image") ? course.thumbnail.src : "";

                // サムネイル生成
                let thumbHtml = '';
                let newBadgeHtml = course.thumbnail.isNew 
                    ? `<div class="absolute top-3 left-3 z-10"><span class="px-2.5 py-1 rounded-lg bg-amber-400/90 backdrop-blur text-white text-[10px] font-bold shadow-sm">NEW</span></div>` 
                    : '';

                if (course.thumbnail.type === 'image') {
                    thumbHtml = `
                        <div class="course-img-wrapper relative aspect-[16/10] overflow-hidden bg-gray-100">
                            <img src="${course.thumbnail.src}" alt="${course.thumbnail.alt}" class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            ${newBadgeHtml}
                        </div>`;
                } else if (course.thumbnail.type === 'icon') {
                    thumbHtml = `
                        <div class="course-img-wrapper relative aspect-[16/10] overflow-hidden ${course.thumbnail.bgClass} grid place-items-center transition-colors">
                            <div class="text-center p-6">
                                <div class="h-12 w-12 mx-auto bg-white rounded-2xl shadow-sm grid place-items-center mb-3 ${course.thumbnail.iconColor} group-hover:scale-110 transition-transform">
                                    <span class="material-symbols-outlined text-2xl">${course.thumbnail.iconName}</span>
                                </div>
                                <h3 class="text-lg font-bold text-slate-700">${course.title}</h3>
                            </div>
                            ${newBadgeHtml}
                        </div>`;
                } else if (course.thumbnail.type === 'text-overlay') {
                    thumbHtml = `
                        <div class="course-img-wrapper relative aspect-[16/10] overflow-hidden ${course.thumbnail.bgClass} grid place-items-center">
                            <h3 class="font-bold text-2xl text-slate-700 px-6 text-center group-hover:scale-105 transition-transform">${course.thumbnail.overlayText}</h3>
                            ${newBadgeHtml}
                        </div>`;
                }

                html += `
                    <a href="${course.url}" class="course-card group flex flex-col bg-white rounded-3xl overflow-hidden ring-1 ring-slate-200 hover:ring-sky-500/30 shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 relative">
                        ${thumbHtml}
                        <button type="button" class="btn-fav flex absolute top-3 right-3 p-2 rounded-full bg-white/80 hover:bg-white text-gray-400 hover:text-rose-500 shadow-sm transition-colors z-10" 
                            data-id="${course.id}" data-title="${course.title}" data-img="${favImgSrc}" data-link="${course.url}" aria-label="お気に入り">
                            <span class="material-symbols-outlined text-[22px]">favorite</span>
                        </button>
                        <div class="flex flex-col flex-1 p-5">
                            <div class="flex gap-2 mb-2">${tagsHtml}</div>
                            <h3 class="text-lg font-bold text-slate-900 line-clamp-2 mb-1 group-hover:text-sky-600 transition-colors">${course.title}</h3>
                            <p class="text-sm text-slate-500 line-clamp-2 mb-3 leading-normal">${course.desc}</p>
                            <div class="mt-auto pt-3 border-t border-slate-100 flex items-center justify-between">
                                <div>
                                    <span class="text-lg font-bold text-slate-900">${course.price.toLocaleString()}<span class="text-xs font-normal text-slate-500 ml-0.5">円</span></span>
                                </div>
                                <div class="flex items-center text-xs font-bold text-slate-500 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
                                    <span class="material-symbols-outlined text-sm mr-1.5">schedule</span> ${course.period}ヶ月
                                </div>
                            </div>
                        </div>
                    </a>`;
            });

            container.insertAdjacentHTML('beforeend', html);
            currentOffset += nextBatch.length;
            applyLayoutMode();
            
            // ハートボタンの状態同期
            if (typeof initFavoritesLogic === 'function') {
                const btns = container.querySelectorAll('.btn-fav');
                const favs = JSON.parse(localStorage.getItem('my_favorites') || '[]');
                btns.forEach(btn => {
                    if(favs.some(i => i.id === btn.dataset.id)) {
                        btn.classList.add('heart-active');
                    }
                });
            }

            isLoading = false;
            
            // 全件読み込んだら監視終了
            if (currentOffset >= courseList.length) {
                sentinel.classList.add('hidden');
                // observer.disconnect(); // ※ソートで再利用するため切断しないほうが良い
            } else {
                sentinel.classList.add('opacity-0');
            }
        }, 400); // 待ち時間を少し短縮
    }

    // ==========================================
    // 3. Intersection Observer
    // ==========================================
    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && typeof courseList !== 'undefined' && currentOffset < courseList.length) {
            loadMoreCourses();
        }
    }, { rootMargin: '100px' });

    // ==========================================
    // 4. View Mode Toggle
    // ==========================================
    function initViewToggle() {
        const btnGrid = document.getElementById('view-toggle-grid');
        const btnList = document.getElementById('view-toggle-list');
        if(btnGrid) btnGrid.onclick = () => { isListMode = false; updateToggleButtons(); applyLayoutMode(); };
        if(btnList) btnList.onclick = () => { isListMode = true; updateToggleButtons(); applyLayoutMode(); };
    }
    function updateToggleButtons() {
        const btnGrid = document.getElementById('view-toggle-grid');
        const btnList = document.getElementById('view-toggle-list');
        if (isListMode) {
            btnList.className = "flex p-2 rounded-full bg-sky-100 text-sky-600 shadow-inner transition";
            btnGrid.className = "flex p-2 rounded-full text-gray-400 hover:bg-gray-100 transition";
        } else {
            btnGrid.className = "flex p-2 rounded-full bg-sky-100 text-sky-600 shadow-inner transition";
            btnList.className = "flex p-2 rounded-full text-gray-400 hover:bg-gray-100 transition";
        }
    }
    function applyLayoutMode() {
        const container = document.getElementById('course-panel');
        if (!container) return;
        const cards = Array.from(container.children);
        const GRID_CONTAINER = ['md:grid-cols-2', 'lg:grid-cols-3'];
        const LIST_CONTAINER = ['grid-cols-1', 'max-w-6xl', 'mx-auto'];

        if (isListMode) {
            container.classList.remove(...GRID_CONTAINER);
            container.classList.add(...LIST_CONTAINER);
        } else {
            container.classList.remove(...LIST_CONTAINER);
            container.classList.add(...GRID_CONTAINER);
        }
        cards.forEach(card => {
            const imgWrapper = card.querySelector('.course-img-wrapper');
            if (isListMode) {
                card.classList.add('md:flex-row');
                if(imgWrapper) {
                    imgWrapper.classList.remove('aspect-[16/10]');
                    imgWrapper.classList.add('md:w-72', 'md:aspect-video', 'shrink-0');
                }
            } else {
                card.classList.remove('md:flex-row');
                if(imgWrapper) {
                    imgWrapper.classList.add('aspect-[16/10]');
                    imgWrapper.classList.remove('md:w-72', 'md:aspect-video', 'shrink-0');
                }
            }
        });
    }

    // ==========================================
    // ★追加: 並び替えロジック
    // ==========================================
    function sortCourses(type) {
        if (typeof courseList === 'undefined') return;

        // 配列をソート（破壊的変更でOK）
        courseList.sort((a, b) => {
            if (type === 'recommend') {
                // UI上の表記「期間が短い順」に合わせます
                return a.period - b.period;
            } else if (type === 'new') {
                // UI上の表記「期間が長い順」に合わせます
                return b.period - a.period;
            } else if (type === 'price_asc') {
                return a.price - b.price;
            } else if (type === 'price_desc') {
                return b.price - a.price;
            }
            return 0;
        });

        // 画面リセット
        const container = document.getElementById('course-panel');
        container.innerHTML = ''; // クリア
        currentOffset = 0;        // カウントリセット
        
        // Sentinelを再表示してローディング可能にする
        const sentinel = document.getElementById('loading-sentinel');
        sentinel.classList.remove('hidden');

        // 再読み込み
        loadMoreCourses();
    }


    // ==========================================
    // 5. Main Initialization
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        initViewToggle();
        
        // --- ★SP検索 UX改善: スマホではinputをボタン化 ---
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('btn-filter');
        
        if (searchInput && filterBtn) {
            // SPサイズかどうか判定して挙動を変える関数
            const handleInputBehavior = () => {
                if (window.matchMedia("(max-width: 768px)").matches) {
                    // スマホ: 読み取り専用にして、クリックでフィルタボタンを発火
                    searchInput.setAttribute('readonly', 'true');
                    searchInput.style.cursor = 'pointer';
                    // プレースホルダーも変更するとより親切
                    searchInput.setAttribute('placeholder', 'タップして検索・絞り込み');
                } else {
                    // PC: 通常の入力
                    searchInput.removeAttribute('readonly');
                    searchInput.style.cursor = 'text';
                    searchInput.setAttribute('placeholder', 'コース名やキーワードで検索');
                }
            };

            // 初回実行
            handleInputBehavior();
            // リサイズ時にも実行
            window.addEventListener('resize', handleInputBehavior);

            // クリックイベント
            searchInput.addEventListener('click', (e) => {
                if (window.matchMedia("(max-width: 768px)").matches) {
                    e.preventDefault();
                    // フィルタモーダルを開くボタンをクリックしたことにする
                    filterBtn.click();
                    // モーダル内のキーワード入力にフォーカスを当てる（少し遅延させる）
                    setTimeout(() => {
                        const modalInput = document.getElementById('filter-keyword');
                        if(modalInput) modalInput.focus();
                    }, 100);
                }
            });
        }
        // ---------------------------------------------------

        // Sentinelの監視開始
        const sentinel = document.getElementById('loading-sentinel');
        if (sentinel) {
            observer.observe(sentinel);
        } else {
            loadMoreCourses(); 
        }

        // 初回ロード（HTMLの定義順を考慮し、デフォルトソートを実行してから表示）
        // ここではデフォルト 'recommend' (期間短い順) で一度ソートしておきます
        sortCourses('recommend');
    });

    // ==========================================
    // 6. Existing Features (Carousel, Modals)
    // ==========================================
    
    // --- Carousel Logic (省略なし) ---
    (() => {
        const root = document.getElementById('hero');
        if (!root) return;
        const items = Array.from(root.children);
        const prev = document.querySelector('[data-prev]');
        const next = document.querySelector('[data-next]');
        const dotsWrap = document.getElementById('hero-dots');
        function buildDots() {
            if (!dotsWrap) return;
            dotsWrap.innerHTML = '';
            items.forEach((_, idx) => {
                const dot = document.createElement('span');
                dot.className = 'h-2.5 w-2.5 rounded-full border border-slate-300 bg-white shadow-sm transition-all duration-200 cursor-pointer';
                dot.addEventListener('click', () => centerTo(idx));
                dotsWrap.appendChild(dot);
            });
        }
        function updateIndicator(i){
            if (!dotsWrap) return;
            dotsWrap.querySelectorAll('span').forEach((el, idx) => {
                el.classList.toggle('bg-sky-500', idx === i);
                el.classList.toggle('border-sky-500', idx === i);
            });
        }
        function centerTo(i){
            i = Math.max(0, Math.min(items.length - 1, i));
            const el = items[i];
            if (!el) return;
            const target = el.offsetLeft - (root.clientWidth - el.clientWidth) / 2;
            root.scrollTo({ left: target, behavior: 'smooth' });
        }
        function current(){ const c=root.scrollLeft + root.clientWidth/2; let bi=0,bd=Infinity; items.forEach((el,i)=>{const m=el.offsetLeft+el.clientWidth/2; const d=Math.abs(m-c); if(d<bd){bd=d;bi=i;}}); return bi; }
        prev?.addEventListener('click',()=>centerTo(current()-1));
        next?.addEventListener('click',()=>centerTo(current()+1));
        window.addEventListener('resize',()=>centerTo(current()));
        let raf = null;
        root.addEventListener('scroll', () => {
            if (raf) cancelAnimationFrame(raf);
            raf = requestAnimationFrame(() => updateIndicator(current()));
        });
        buildDots();
        updateIndicator(current());
    })();

    // --- Sort Modal Logic (★修正: ソート実行を追加) ---
    (() => {
        const dialog = document.getElementById('sort-dialog');
        const backdrop = document.getElementById('sort-backdrop');
        const panel = document.getElementById('sort-panel');
        const btnOpen = document.getElementById('btn-sort');
        const btnClose = document.getElementById('sort-close');
        const options = dialog ? dialog.querySelectorAll('.sort-option') : [];

        let currentSort = 'recommend';

        if(!dialog) return;

        function openSort() {
            dialog.classList.remove('hidden');
            requestAnimationFrame(() => {
                backdrop.style.opacity = '1';
                panel.style.transform = 'translateY(0)';
            });
            updateCheckmarks();
        }
        function closeSort() {
            backdrop.style.opacity = '0';
            panel.style.transform = 'translateY(100%)';
            setTimeout(() => dialog.classList.add('hidden'), 200);
        }
        function updateCheckmarks() {
            options.forEach(btn => {
                const isSelected = btn.dataset.val === currentSort;
                const check = btn.querySelector('.material-symbols-outlined');
                if (isSelected) {
                    btn.classList.add('text-sky-700', 'bg-sky-50');
                    btn.classList.remove('text-gray-600');
                    check.classList.remove('opacity-0');
                    check.classList.add('opacity-100');
                } else {
                    btn.classList.remove('text-sky-700', 'bg-sky-50');
                    btn.classList.add('text-gray-600');
                    check.classList.remove('opacity-100');
                    check.classList.add('opacity-0');
                }
            });
        }

        btnOpen?.addEventListener('click', openSort);
        btnClose?.addEventListener('click', closeSort);
        backdrop?.addEventListener('click', closeSort);

        options.forEach(btn => {
            btn.addEventListener('click', () => {
                currentSort = btn.dataset.val;
                updateCheckmarks();
                
                // ★追加: 実際にソートを実行
                sortCourses(currentSort);

                setTimeout(closeSort, 150); 
            });
        });
    })();

    // --- Filter Modal & UI Logic (★省略なし) ---
    (() => {
        const dialog   = document.getElementById('filter-dialog');
        if(!dialog) return;

        const backdrop = document.getElementById('filter-backdrop');
        const panel    = document.getElementById('filter-panel');
        const btnOpen  = document.getElementById('btn-filter');
        const btnClose = document.getElementById('filter-close');
        const btnApply = document.getElementById('filter-apply');
        const btnReset = document.getElementById('filter-reset');
        const chips    = Array.from(dialog.querySelectorAll('[data-chip]'));
        const keyword  = document.getElementById('filter-keyword');
        const durationChecks = Array.from(dialog.querySelectorAll('input[type="checkbox"]'));

        let last = null;
        function animateIn(){
            dialog.classList.remove('hidden');
            requestAnimationFrame(() => {
                backdrop.style.opacity = '1';
                panel.style.opacity = '1';
                panel.style.transform = 'translateY(0) scale(1)';
            });
        }
        function animateOut(){
            backdrop.style.opacity = '0';
            panel.style.opacity = '0';
            panel.style.transform = 'translateY(1.5rem) scale(0.97)';
            setTimeout(() => dialog.classList.add('hidden'), 180);
        }
        function openDlg(){
            last = document.activeElement;
            backdrop.style.opacity = '0';
            panel.style.opacity = '0';
            panel.style.transform = 'translateY(1.5rem) scale(0.97)';
            animateIn();
            btnOpen?.setAttribute('aria-expanded','true');
            setTimeout(() => document.getElementById('filter-keyword')?.focus(), 60);
        }
        function closeDlg(){
            animateOut();
            btnOpen?.setAttribute('aria-expanded','false');
            last?.focus();
        }

        // btnOpenクリック時は通常通り開く（SP時のFake Inputからのトリガーもこれを叩く）
        btnOpen?.addEventListener('click', openDlg);
        btnClose?.addEventListener('click', closeDlg);
        backdrop?.addEventListener('click', (e) => { if (e.target === backdrop) closeDlg(); });

        dialog.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { e.preventDefault(); closeDlg(); }
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); btnApply?.click(); }
        });

        const rMin = document.getElementById('range-min');
        const rMax = document.getElementById('range-max');
        const fill = document.getElementById('price-fill');
        const lMin = document.getElementById('price-min');
        const lMax = document.getElementById('price-max');
        function updateRange(){
            if(!rMin || !rMax) return;
            let min = Math.min(+rMin.value, +rMax.value);
            let max = Math.max(+rMin.value, +rMax.value);
            const minPct = (min / (+rMin.max)) * 100;
            const maxPct = (max / (+rMax.max)) * 100;
            fill.style.left = minPct + '%';
            fill.style.right = (100 - maxPct) + '%';
            lMin.textContent = min.toLocaleString();
            lMax.textContent = max.toLocaleString();
        }
        rMin?.addEventListener('input', updateRange);
        rMax?.addEventListener('input', updateRange);
        updateRange();

        function setChipState(el, active){
            el.setAttribute('aria-pressed', active ? 'true' : 'false');
            el.classList.toggle('bg-sky-100', active);
            el.classList.toggle('border-sky-300', active);
            el.classList.toggle('text-sky-700', active);
        }
        chips.forEach((chip) => {
            setChipState(chip, chip.getAttribute('aria-pressed') === 'true');
            chip.addEventListener('click', () => {
                const next = chip.getAttribute('aria-pressed') !== 'true';
                setChipState(chip, next);
            });
        });

        btnApply?.addEventListener('click', closeDlg);
        btnReset?.addEventListener('click', () => {
            keyword && (keyword.value = '');
            durationChecks.forEach((c) => c.checked = false);
            chips.forEach((chip) => setChipState(chip, false));
            if (rMin) rMin.value = rMin.min || '0';
            if (rMax) rMax.value = rMax.max || '50000';
            updateRange();
        });
    })();

    // --- Banner Close Logic ---
    (() => {
        const banner = document.getElementById('deadline-banner');
        if (!banner) return;
        const closeBtn = document.getElementById('deadline-banner-close');
        closeBtn?.addEventListener('click', () => {
            banner.classList.add('hidden');
        });
    })();
</script>