<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お知らせ管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* 画面切り替えアニメーション */
        .view-transition {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .hidden-view {
            display: none;
            opacity: 0;
            transform: translateX(10px);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <div class="px-6 py-4 border-b border-gray-200 bg-white flex justify-between items-center shadow-sm z-10">
        <h2 class="text-lg font-bold flex items-center gap-2 text-gray-800">
            <span class="material-symbols-outlined text-blue-600">campaign</span>
            <span id="header-title">お知らせ管理</span>
        </h2>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar relative">
        
        <div id="list-view" class="p-6 view-transition">
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-500">募集サイトに表示するお知らせを管理します。</p>
                <button id="add-new-btn" class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold px-4 py-2 rounded-md shadow-sm transition-colors">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    新規作成
                </button>
            </div>

            <div id="announcement-list" class="space-y-3">
                </div>
            
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-white">
                <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">feed</span>
                <p class="text-sm">お知らせはまだ登録されていません</p>
            </div>
        </div>

        <div id="form-view" class="p-6 hidden-view view-transition bg-white min-h-full">
            <form id="edit-form" class="space-y-6 max-w-2xl mx-auto">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">公開日 <span class="text-red-500">*</span></label>
                        <input type="date" id="edit-date" required
                            class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:ring-blue-500 focus:outline-none bg-gray-50">
                    </div>
                    <div class="flex items-end pb-2">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="edit-important" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm font-bold text-gray-700 group-hover:text-red-600 transition-colors select-none">重要なお知らせとして表示</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">タイトル <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-title" required placeholder="例：【重要】募集期間延長のお知らせ"
                        class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:ring-blue-500 focus:outline-none bg-gray-50 placeholder-gray-400">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">本文</label>
                    <textarea id="edit-body" rows="6" placeholder="お知らせの詳細を入力してください..."
                        class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:ring-blue-500 focus:outline-none bg-gray-50 placeholder-gray-400"></textarea>
                    <p class="text-xs text-gray-400 mt-1 text-right">※改行はサイト上で反映されます</p>
                </div>
            </form>
        </div>
    </div>

    <div class="px-6 py-4 border-t border-gray-200 bg-white flex justify-end gap-3 sticky bottom-0 z-10">
        <div id="list-actions" class="w-full flex justify-end">
            <button type="button" id="close-btn-bottom" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                閉じる
            </button>
        </div>

        <div id="form-actions" class="hidden w-full flex justify-between">
            <button type="button" id="cancel-edit-btn" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                一覧に戻る
            </button>
            <button type="button" id="save-btn" class="px-6 py-2 text-sm font-bold text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 shadow-sm transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">save</span>
                保存する
            </button>
        </div>
    </div>

    <script>
        // --- Mock Data ---
        let announcements = [
            { 
                id: 1, 
                date: '2026-01-10', 
                important: true, 
                title: '募集期間を延長しました', 
                body: 'ご好評につき、募集期間を2026年2月28日まで延長いたします。\n皆様のご応募をお待ちしております。' 
            },
            { 
                id: 2, 
                date: '2025-12-25', 
                important: false, 
                title: '年末年始の営業について', 
                body: '12月29日から1月4日まで事務局は休業となります。お問い合わせへの回答は1月5日以降順次対応させていただきます。' 
            },
            {
                id: 3, 
                date: '2025-12-01', 
                important: false, 
                title: '募集サイトを公開しました', 
                body: '2026年度の募集を開始いたしました。' 
            }
        ];

        // --- DOM Elements ---
        const listView = document.getElementById('list-view');
        const formView = document.getElementById('form-view');
        const listActions = document.getElementById('list-actions');
        const formActions = document.getElementById('form-actions');
        const headerTitle = document.getElementById('header-title');
        const announcementList = document.getElementById('announcement-list');
        const emptyState = document.getElementById('empty-state');

        // Form Inputs
        const editIdInput = document.getElementById('edit-id');
        const editDateInput = document.getElementById('edit-date');
        const editImportantInput = document.getElementById('edit-important');
        const editTitleInput = document.getElementById('edit-title');
        const editBodyInput = document.getElementById('edit-body');

        // --- State Management ---
        function switchView(mode) {
            if (mode === 'form') {
                // Form View
                listView.classList.add('hidden-view');
                formView.classList.remove('hidden-view');
                listActions.classList.add('hidden');
                formActions.classList.remove('hidden');
                formActions.classList.add('flex');
            } else {
                // List View
                formView.classList.add('hidden-view');
                listView.classList.remove('hidden-view');
                
                // フッターボタンの表示切り替え（修正済み）
                formActions.classList.add('hidden');
                formActions.classList.remove('flex'); 
                
                listActions.classList.remove('hidden');
                
                headerTitle.textContent = 'お知らせ管理';
                renderList();
            }
        }

        // --- Rendering ---
        function renderList() {
            announcementList.innerHTML = '';
            
            if (announcements.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            // 日付順ソート (新しい順)
            const sortedData = [...announcements].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedData.forEach(item => {
                const importantBadge = item.important 
                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600 border border-red-200">重要</span>` 
                    : '';
                
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow flex gap-4 group';
                div.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-mono text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${item.date}</span>
                            ${importantBadge}
                        </div>
                        <h3 class="font-bold text-gray-800 text-base mb-1 truncate">${item.title}</h3>
                        <p class="text-xs text-gray-500 line-clamp-1">${item.body}</p>
                    </div>
                    <div class="flex flex-col gap-2 justify-center border-l border-gray-100 pl-4">
                        <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-800 p-1.5 rounded hover:bg-blue-50 transition-colors" title="編集">
                            <span class="material-symbols-outlined icon-md">edit</span>
                        </button>
                        <button onclick="deleteItem(${item.id})" class="text-gray-400 hover:text-red-600 p-1.5 rounded hover:bg-red-50 transition-colors" title="削除">
                            <span class="material-symbols-outlined icon-md">delete</span>
                        </button>
                    </div>
                `;
                announcementList.appendChild(div);
            });
        }

        // --- Actions ---
        window.editItem = (id) => {
            const item = announcements.find(a => a.id === id);
            if (!item) return;

            editIdInput.value = item.id;
            editDateInput.value = item.date;
            editImportantInput.checked = item.important;
            editTitleInput.value = item.title;
            editBodyInput.value = item.body;

            headerTitle.textContent = 'お知らせの編集';
            switchView('form');
        };

        window.deleteItem = (id) => {
            if (confirm('このお知らせを削除してもよろしいですか？')) {
                announcements = announcements.filter(a => a.id !== id);
                renderList();
            }
        };

        document.getElementById('add-new-btn').addEventListener('click', () => {
            // Reset form
            editIdInput.value = '';
            // Default to today
            const today = new Date().toISOString().split('T')[0];
            editDateInput.value = today;
            editImportantInput.checked = false;
            editTitleInput.value = '';
            editBodyInput.value = '';

            headerTitle.textContent = '新規お知らせ登録';
            switchView('form');
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            switchView('list');
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            const title = editTitleInput.value.trim();
            const date = editDateInput.value;
            
            if (!title || !date) {
                alert('公開日とタイトルは必須項目です。');
                return;
            }

            const id = editIdInput.value ? parseInt(editIdInput.value) : Date.now();
            const newItem = {
                id: id,
                date: date,
                important: editImportantInput.checked,
                title: title,
                body: editBodyInput.value
            };

            // Update or Add
            const existingIndex = announcements.findIndex(a => a.id === id);
            if (existingIndex >= 0) {
                announcements[existingIndex] = newItem;
            } else {
                announcements.push(newItem);
            }

            // Save visual feedback
            const btn = document.getElementById('save-btn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">refresh</span> 保存中...';
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                switchView('list');
            }, 500);
        });

        // Close Modal Helper
        function closeModal() {
            window.parent.postMessage({ type: 'closeModal' }, '*');
        }

        // Bottom close button
        const bottomCloseBtn = document.getElementById('close-btn-bottom');
        if (bottomCloseBtn) {
            bottomCloseBtn.addEventListener('click', closeModal);
        }

        // Initial Render
        renderList();

    </script>
</body>
</html>