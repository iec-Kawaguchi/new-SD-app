<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>申込承認（ユーザー×コース単位）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    body { font-family: "游ゴシック体","Yu Gothic","游ゴシック",YuGothic,sans-serif; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="min-h-dvh p-6 space-y-6">

    <!-- ヘッダー -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-blue-700">assignment_turned_in</span>
        <div>
          <h1 class="text-xl font-bold">申込承認</h1>
          <p class="text-xs text-gray-500">
            申込期間と開講日で絞り込んだうえで、ユーザー×コース単位で承認 / 否認を一括設定します。
          </p>
        </div>
      </div>
      <!-- 戻る（集計画面へ） -->
      <a href="application-stats-sample.html"
         class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-gray-300 bg-white text-xs text-gray-700 hover:bg-gray-50">
        <span class="material-symbols-outlined text-sm">arrow_back</span>
        集計画面へ戻る
      </a>
    </div>

    <!-- フィルタバー：申込期間 × 開講日 -->
    <div class="flex flex-wrap items-center gap-3">
      <!-- 申込期間 -->
      <div class="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-full px-3 py-1.5 shadow-sm">
        <span class="material-symbols-outlined text-gray-400 text-base">event_upcoming</span>
        <span class="text-xs text-gray-500">申込期間</span>
        <select id="filter-period"
                class="bg-transparent text-sm font-medium text-gray-900 border-none focus:outline-none focus:ring-0">
        </select>
      </div>
      <!-- 開講日 -->
      <div class="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-full px-3 py-1.5 shadow-sm">
        <span class="material-symbols-outlined text-gray-400 text-base">calendar_month</span>
        <span class="text-xs text-gray-500">開講日</span>
        <select id="filter-opening"
                class="bg-transparent text-sm font-medium text-gray-900 border-none focus:outline-none focus:ring-0">
        </select>
      </div>

      <!-- ラベル -->
      <div class="flex items-center gap-1 text-xs text-gray-500">
        <span class="material-symbols-outlined text-[16px] text-gray-400">info</span>
        <span id="filter-label">すべての申込期間・開講日を対象</span>
      </div>
    </div>

    <!-- サマリー -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="bg-white p-4 rounded-xl shadow flex flex-col">
        <div class="text-gray-500 text-sm">対象ユーザー数</div>
        <div id="summary-users" class="text-3xl font-bold mt-2">0</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow flex flex-col">
        <div class="text-gray-500 text-sm">申込件数</div>
        <div id="summary-applications" class="text-3xl font-bold mt-2">0</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow flex flex-col">
        <div class="text-gray-500 text-sm">未承認の申込</div>
        <div id="summary-pending" class="text-3xl font-bold mt-2 text-orange-500">0</div>
      </div>
    </div>

    <!-- 申込一覧（ユーザー×コース 1 行） -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold flex items-center gap-1">
          <span class="material-symbols-outlined text-gray-500">view_list</span>
          申込一覧（ユーザー×コース）
        </h2>
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100">
            <span class="w-2 h-2 rounded-full bg-blue-500"></span> 承認
          </span>
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100">
            <span class="w-2 h-2 rounded-full bg-red-500"></span> 否認
          </span>
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100">
            <span class="w-2 h-2 rounded-full bg-orange-400"></span> 保留 / 未承認
          </span>
        </div>
      </div>

      <!-- 一括操作バー -->
      <div class="flex flex-wrap items-center justify-between gap-3 text-xs">
        <div class="flex items-center gap-2">
          <span id="selected-count" class="text-gray-500">選択中：0件</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-approve-selected"
                  class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-blue-600 text-white font-semibold disabled:opacity-40 disabled:cursor-not-allowed hover:bg-blue-500 text-xs"
                  disabled>
            <span class="material-symbols-outlined text-sm">done_all</span>
            選択行を承認
          </button>
          <button id="btn-deny-selected"
                  class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-red-600 text-white font-semibold disabled:opacity-40 disabled:cursor-not-allowed hover:bg-red-500 text-xs"
                  disabled>
            <span class="material-symbols-outlined text-sm">cancel</span>
            選択行を否認
          </button>
          <!-- <button id="btn-pend-selected"
                  class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-700 text-white font-semibold disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-600 text-xs"
                  disabled>
            <span class="material-symbols-outlined text-sm">pause_circle</span>
            選択行を保留に戻す
          </button> -->
        </div>
      </div>

      <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-100 text-xs">
            <tr>
              <th class="p-3 w-10 text-center">
                <input type="checkbox" id="check-all"
                       class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
              </th>
              <th class="p-3 font-semibold">ユーザー</th>
              <th class="p-3 font-semibold">所属</th>
              <th class="p-3 font-semibold">コース名</th>
              <th class="p-3 font-semibold">申込日</th>
              <th class="p-3 font-semibold">開講日</th>
              <th class="p-3 font-semibold">現在ステータス</th>
              <th class="p-3 font-semibold w-48">コメント</th>
            </tr>
          </thead>
          <tbody id="application-rows">
            <!-- JSで行をレンダリング -->
          </tbody>
        </table>
      </div>

      <div class="flex justify-end">
        <button id="btn-save-all"
                class="inline-flex items-center gap-1 px-4 py-2 rounded-full bg-blue-600 text-white text-xs font-semibold hover:bg-blue-500">
          <span class="material-symbols-outlined text-sm">save</span>
          変更を保存（モック）
        </button>
      </div>
    </section>
  </div>

  <script>
    // ====== フィルタの前提（stats 画面と合わせる） ======
    const PERIODS = [
      { id: "all",       label: "すべての申込期間" },
      { id: "2026-h1",   label: "2026年度上期募集（例：2026/05/01〜05/15）" },
      { id: "2026-h2",   label: "2026年度下期募集（例：2026/11/01〜11/15）" }
    ];

    const OPENINGS_BY_PERIOD = {
      "all": [
        { id: "all", label: "すべての開講日" }
      ],
      "2026-h1": [
        { id: "all",        label: "すべての開講日" },
        { id: "2026-06-01", label: "2026/06/01 開講" },
        { id: "2026-07-01", label: "2026/07/01 開講" }
      ],
      "2026-h2": [
        { id: "all",        label: "すべての開講日" },
        { id: "2026-12-01", label: "2026/12/01 開講" },
        { id: "2026-12-15", label: "2026/12/15 開講" },
        { id: "2027-01-05", label: "2027/01/05 開講" }
      ]
    };

    // ====== 申込データ（1レコード = 1ユーザー×1コース×1開講） ======
    // action: 承認 / 否認 / 保留（承認ワークフロー上の内部状態）
    const APPLICATION_STATS = [
      {
        periodId: "all",
        openingId: "all",
        applications: [
          {
            id: "a001",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "基礎から学ぶExcel",
            appliedAt: "2026/05/02",
            openingDate: "2026/06/01",
            status: "申請中",
            action: "保留",
            comment: ""
          },
          {
            id: "a002",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "DX入門",
            appliedAt: "2026/05/05",
            openingDate: "2026/06/01",
            status: "承認済み",
            action: "承認",
            comment: ""
          },
          {
            id: "a003",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "ビジネス文章講座",
            appliedAt: "2026/05/10",
            openingDate: "2026/07/01",
            status: "申請中",
            action: "保留",
            comment: ""
          },
          {
            id: "a004",
            userId: "u002",
            userName: "佐藤 花子",
            org: "人事部",
            courseName: "DX入門",
            appliedAt: "2026/11/03",
            openingDate: "2026/12/01",
            status: "承認済み",
            action: "承認",
            comment: ""
          },
          {
            id: "a005",
            userId: "u002",
            userName: "佐藤 花子",
            org: "人事部",
            courseName: "ビジネス文章講座",
            appliedAt: "2026/11/05",
            openingDate: "2026/12/15",
            status: "承認済み",
            action: "承認",
            comment: ""
          },
          {
            id: "a006",
            userId: "u003",
            userName: "鈴木 一郎",
            org: "第二営業部",
            courseName: "プロジェクト管理",
            appliedAt: "2026/05/12",
            openingDate: "2026/07/01",
            status: "申請中",
            action: "保留",
            comment: ""
          }
        ]
      },
      // 2026-h1 × all
      {
        periodId: "2026-h1",
        openingId: "all",
        applications: [
          {
            id: "a001",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "基礎から学ぶExcel",
            appliedAt: "2026/05/02",
            openingDate: "2026/06/01",
            status: "申請中",
            action: "保留",
            comment: ""
          },
          {
            id: "a002",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "DX入門",
            appliedAt: "2026/05/05",
            openingDate: "2026/06/01",
            status: "承認済み",
            action: "承認",
            comment: ""
          },
          {
            id: "a003",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "ビジネス文章講座",
            appliedAt: "2026/05/10",
            openingDate: "2026/07/01",
            status: "申請中",
            action: "保留",
            comment: ""
          },
          {
            id: "a006",
            userId: "u003",
            userName: "鈴木 一郎",
            org: "第二営業部",
            courseName: "プロジェクト管理",
            appliedAt: "2026/05/12",
            openingDate: "2026/07/01",
            status: "申請中",
            action: "保留",
            comment: ""
          }
        ]
      },
      // 2026-h1 × 2026-06-01
      {
        periodId: "2026-h1",
        openingId: "2026-06-01",
        applications: [
          {
            id: "a001",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "基礎から学ぶExcel",
            appliedAt: "2026/05/02",
            openingDate: "2026/06/01",
            status: "申請中",
            action: "保留",
            comment: ""
          },
          {
            id: "a002",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "DX入門",
            appliedAt: "2026/05/05",
            openingDate: "2026/06/01",
            status: "承認済み",
            action: "承認",
            comment: ""
          }
        ]
      },
      // 2026-h1 × 2026-07-01
      {
        periodId: "2026-h1",
        openingId: "2026-07-01",
        applications: [
          {
            id: "a003",
            userId: "u001",
            userName: "山田 太郎",
            org: "第一営業部",
            courseName: "ビジネス文章講座",
            appliedAt: "2026/05/10",
            openingDate: "2026/07/01",
            status: "申請中",
            action: "保留",
            comment: ""
          },
          {
            id: "a006",
            userId: "u003",
            userName: "鈴木 一郎",
            org: "第二営業部",
            courseName: "プロジェクト管理",
            appliedAt: "2026/05/12",
            openingDate: "2026/07/01",
            status: "申請中",
            action: "保留",
            comment: ""
          }
        ]
      }
      // 必要に応じて 2026-h2 も追加
    ];

    // ====== DOM ======
    const periodSelect    = document.getElementById("filter-period");
    const openingSelect   = document.getElementById("filter-opening");
    const filterLabel     = document.getElementById("filter-label");
    const rowsBody        = document.getElementById("application-rows");
    const summaryUsers    = document.getElementById("summary-users");
    const summaryApps     = document.getElementById("summary-applications");
    const summaryPending  = document.getElementById("summary-pending");
    const btnSaveAll      = document.getElementById("btn-save-all");
    const checkAll        = document.getElementById("check-all");
    const selectedCountEl = document.getElementById("selected-count");
    const btnApproveSel   = document.getElementById("btn-approve-selected");
    const btnDenySel      = document.getElementById("btn-deny-selected");
    //const btnPendSel      = document.getElementById("btn-pend-selected");

    let currentPeriodId  = "all";
    let currentOpeningId = "all";

    // ====== フィルタ初期化 ======
    function initPeriodOptions() {
      PERIODS.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.label;
        periodSelect.appendChild(opt);
      });
      periodSelect.value = "all";
    }

    function initOpeningOptions(periodId) {
      openingSelect.innerHTML = "";
      const list = OPENINGS_BY_PERIOD[periodId] || OPENINGS_BY_PERIOD["all"];
      list.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.id;
        opt.textContent = o.label;
        openingSelect.appendChild(opt);
      });

      if (periodId === "all") {
        openingSelect.value = "all";
        openingSelect.disabled = true;
        openingSelect.classList.add("text-gray-400");
      } else {
        openingSelect.disabled = false;
        openingSelect.classList.remove("text-gray-400");
      }
    }

    function updateFilterLabel() {
      const period = PERIODS.find(p => p.id === currentPeriodId);
      const openings = OPENINGS_BY_PERIOD[currentPeriodId] || OPENINGS_BY_PERIOD["all"];
      const opening  = openings.find(o => o.id === currentOpeningId) || openings[0];

      if (currentPeriodId === "all") {
        filterLabel.textContent = "すべての申込期間・開講日を対象";
      } else if (currentOpeningId === "all") {
        filterLabel.textContent = `${period?.label ?? ""}／すべての開講日を対象`;
      } else {
        filterLabel.textContent = `${period?.label ?? ""}／${opening?.label ?? ""} を対象`;
      }
    }

    function findApplications(periodId, openingId) {
      let found = APPLICATION_STATS.find(s => s.periodId === periodId && s.openingId === openingId);
      if (!found) {
        found = APPLICATION_STATS.find(s => s.periodId === periodId && s.openingId === "all");
      }
      if (!found) {
        found = APPLICATION_STATS.find(s => s.periodId === "all" && s.openingId === "all");
      }
      return found?.applications ?? [];
    }

    // ====== 選択状態の更新 ======
    function updateSelectionState() {
      const checkboxes = rowsBody.querySelectorAll('input[type="checkbox"][data-app-id]');
      let selectedCount = 0;
      checkboxes.forEach(cb => { if (cb.checked) selectedCount++; });

      selectedCountEl.textContent = `選択中：${selectedCount}件`;
      const disabled = selectedCount === 0;
      [btnApproveSel, btnDenySel].forEach(btn => {
        btn.disabled = disabled;
      });

      // 全選択チェックボックスの状態
      if (checkboxes.length === 0) {
        checkAll.checked = false;
        checkAll.indeterminate = false;
      } else if (selectedCount === 0) {
        checkAll.checked = false;
        checkAll.indeterminate = false;
      } else if (selectedCount === checkboxes.length) {
        checkAll.checked = true;
        checkAll.indeterminate = false;
      } else {
        checkAll.checked = false;
        checkAll.indeterminate = true;
      }
    }

    function applyBulkAction(actionLabel) {
      const checkboxes = rowsBody.querySelectorAll('input[type="checkbox"][data-app-id]');
      const targets = [];
      checkboxes.forEach(cb => {
        if (cb.checked) targets.push(cb.getAttribute("data-app-id"));
      });
      if (targets.length === 0) return;

      const ok = confirm(`選択中の ${targets.length} 件を「${actionLabel}」に更新します。よろしいですか？`);
      if (!ok) return;

      // 全グループの applications から該当IDの action を更新
      APPLICATION_STATS.forEach(group => {
        group.applications.forEach(a => {
          if (targets.includes(a.id)) {
            a.action = actionLabel;
          }
        });
      });

      // 再描画（選択状態はクリアされる）
      renderApplications();
    }

    // ====== 描画 ======
    function renderApplications() {
      const apps = findApplications(currentPeriodId, currentOpeningId);

      // サマリー
      const userSet = new Set(apps.map(a => a.userId));
      summaryUsers.textContent   = userSet.size;
      summaryApps.textContent    = apps.length;
      summaryPending.textContent = apps.filter(a => a.action === "保留" || a.status === "申請中").length;

      rowsBody.innerHTML = "";
      checkAll.checked = false;
      checkAll.indeterminate = false;
      selectedCountEl.textContent = "選択中：0件";
      [btnApproveSel, btnDenySel].forEach(btn => btn.disabled = true);

      if (apps.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="p-4 text-center text-xs text-gray-500" colspan="8">
          対象の申込はありません。
        </td>`;
        rowsBody.appendChild(tr);
        return;
      }

      apps.forEach(app => {
        const tr = document.createElement("tr");
        tr.className = "border-t hover:bg-gray-50/70";
        const dotClass =
          app.action === "承認" ? "bg-blue-500"
          : app.action === "否認" ? "bg-red-500"
          : "bg-orange-400";

        tr.innerHTML = `
          <td class="p-3 align-middle text-center">
            <input type="checkbox"
                   class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 row-check"
                   data-app-id="${app.id}" />
          </td>
          <td class="p-3 align-middle">
            <div class="flex flex-col">
              <span class="font-medium">${app.userName}</span>
              <span class="text-xs text-gray-500">ID: ${app.userId}</span>
            </div>
          </td>
          <td class="p-3 align-middle">
            <span class="text-sm">${app.org}</span>
          </td>
          <td class="p-3 align-middle">
            <span class="text-sm">${app.courseName}</span>
          </td>
          <td class="p-3 align-middle text-xs">
            ${app.appliedAt}
          </td>
          <td class="p-3 align-middle text-xs">
            ${app.openingDate}
          </td>
          <td class="p-3 align-middle text-xs">
            <div class="inline-flex items-center gap-2">
              <span class="w-2 h-2 rounded-full ${dotClass}"></span>
              <span>${app.status}（${app.action}）</span>
            </div>
          </td>
          <td class="p-3 align-middle">
            <input type="text"
                   class="w-full text-xs rounded-md border-gray-300 focus:ring-blue-400 focus:border-blue-400"
                   placeholder="コメント（任意）"
                   data-app-comment="${app.id}"
                   value="${app.comment || ""}" />
          </td>
        `;
        rowsBody.appendChild(tr);
      });

      // チェックボックスイベント
      rowsBody.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener("change", updateSelectionState);
      });

      // コメント入力をデータに反映（blurベースにしておく）
      rowsBody.querySelectorAll('input[data-app-comment]').forEach(inp => {
        inp.addEventListener("blur", () => {
          const appId = inp.getAttribute("data-app-comment");
          const value = inp.value;
          APPLICATION_STATS.forEach(group => {
            group.applications.forEach(a => {
              if (a.id === appId) a.comment = value;
            });
          });
        });
      });
    }

    // ====== 初期化 ======
    document.addEventListener("DOMContentLoaded", () => {
      initPeriodOptions();
      initOpeningOptions("all");
      updateFilterLabel();
      renderApplications();

      periodSelect.addEventListener("change", () => {
        currentPeriodId = periodSelect.value;
        initOpeningOptions(currentPeriodId);
        currentOpeningId = openingSelect.value || "all";
        updateFilterLabel();
        renderApplications();
      });

      openingSelect.addEventListener("change", () => {
        currentOpeningId = openingSelect.value || "all";
        updateFilterLabel();
        renderApplications();
      });

      checkAll.addEventListener("change", () => {
        const checked = checkAll.checked;
        rowsBody.querySelectorAll('.row-check').forEach(cb => {
          cb.checked = checked;
        });
        updateSelectionState();
      });

      btnApproveSel.addEventListener("click", () => applyBulkAction("承認"));
      btnDenySel.addEventListener("click", () => applyBulkAction("否認"));
      //btnPendSel.addEventListener("click", () => applyBulkAction("保留"));

      btnSaveAll.addEventListener("click", () => {
        // 実装時はここで API 連携
        alert("モック：ここでサーバーに承認情報を送信するイメージです。");
      });
    });
  </script>
</body>
</html>
