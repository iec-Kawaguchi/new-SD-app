<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>募集要項登録（Quillエディタ版）</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
        
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

        <style>
            body { font-family:"游ゴシック体","Yu Gothic","游ゴシック",YuGothic,sans-serif; }
            :root { --safe-bottom: env(safe-area-inset-bottom); }
            
            .ql-snow .ql-picker.ql-header { width: auto; }
            .ql-info-box:after {
                content: "見出し"; 
                font-weight: bold;
                color: #0891b2; /* Tailwindのtext-sky-600 */
            }

            .ql-info-box {
                width: auto !important;
                padding: 0 8px !important;
                display: flex;
                align-items: center;
                justify-content: center;
            }
 
            /* Quillのスタイル微調整 */
            .ql-toolbar { border-color: #e5e7eb !important; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; background-color: #f9fafb; }
            .ql-container { border-color: #e5e7eb !important; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: #fff; font-family: inherit; }
            .ql-editor { min-height: 200px; font-size: 1rem; color: #1f2937; }
            /* プレースホルダーの色調整 */
            .ql-editor.ql-blank::before { color: #9ca3af; font-style: normal; }
            /* ヘッダー選択（Normal, H1...）の幅を広げる */
            .ql-snow .ql-picker.ql-header {
                width: 7rem !important;  /* デフォルト(98px)だと狭いので広げる */
            }

            /* 必要に応じてラベルの右側に余白を確保（矢印と文字の重なり防止） */
            .ql-snow .ql-picker.ql-header .ql-picker-label {
                padding-right: 24px !important;
            }
        </style>
    </head>
    <body class="bg-gray-50 text-gray-800 min-h-dvh overflow-y-auto overflow-hidden flex flex-col">
        <header class="px-6 pt-8 pb-4">
            <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
                <span class="material-symbols-outlined text-gray-500">description</span>
                募集要項登録
            </h1>
            <p class="mt-1 text-sm text-gray-600">本募集の募集要項を登録してください。</p>
        </header>

        <main class="flex-1 min-h-0 px-6 pb-40">
            <div class="grid grid-cols-1 gap-6 min-h-0">
                <section class="rounded-2xl bg-white border border-gray-200/70 shadow-sm flex flex-col min-h-0">
                    <div class="px-5 py-5 space-y-8 overflow-y-auto min-h-0">
                        
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-1">サムネイル</label>
                        <p class="text-xs text-gray-500 mb-2">推奨 16:9（横長） / JPG・PNG・WebP / 5MB まで</p>
                        <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1fr)_16rem] gap-4">
                            <div id="thumbDrop" class="group relative rounded-xl border border-dashed border-gray-300 bg-gray-50/60 hover:bg-gray-50 transition p-4 flex items-center justify-center cursor-pointer">
                                <input id="thumbInput" type="file" accept="image/*" class="sr-only" />
                                <div class="text-center pointer-events-none">
                                    <span class="material-symbols-outlined text-3xl text-gray-400 group-hover:text-gray-500">add_photo_alternate</span>
                                    <p class="mt-1 text-sm text-gray-700">画像をドラッグ&ドロップ<br class="hidden sm:block" />または <span class="underline">クリックして選択</span></p>
                                    <p class="text-xs text-gray-500 mt-1">JPG / PNG / WebP（5MBまで）</p>
                                </div>
                                <div id="thumbDropMask" class="hidden absolute inset-0 rounded-xl bg-blue-500/10 ring-2 ring-blue-400 pointer-events-none"></div>
                            </div>
                            <div class="space-y-2">
                                <div class="relative w-full rounded-lg overflow-hidden bg-gray-100 border border-gray-200 aspect-[16/9]">
                                    <img id="thumbPreview" alt="" class="w-full h-full object-cover hidden" />
                                    <div id="thumbEmpty" class="absolute inset-0 grid place-items-center text-gray-400 text-sm">プレビュー（16:9）</div>
                                </div>
                                <div class="flex gap-2">
                                    <button id="thumbSelectBtn" type="button" class="h-10 px-3 rounded-lg bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 flex items-center gap-1"><span class="material-symbols-outlined text-base">upload</span> 画像を選ぶ</button>
                                    <button id="thumbClearBtn" type="button" class="h-10 px-3 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled><span class="material-symbols-outlined text-base">delete</span> クリア</button>
                                </div>
                                <p id="thumbMeta" class="text-xs text-gray-500"></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-900 mb-1">タイトル</label>
                        <div class="flex justify-between w-full max-w-3xl">
                            <p class="text-xs text-gray-500 mb-2">サムネイル未設定時の表示用</p>
                            <div class=" text-xs text-gray-400"><span id="titleCount">0</span>/60</div>
                        </div>
                        <input id="title" type="text" maxlength="60" class="w-full max-w-3xl rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例）FY26 自己啓発制度 募集要項" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-1">本文</label>
                        <div class="flex justify-between w-full max-w-4xl">
                            <p class="text-xs text-gray-500 mb-2">概要・対象・期間・費用・申込方法など（太字やリストが使えます）</p>
                            <div class="text-xs text-gray-400"><span id="bodyCount">0</span>/2000</div>
                        </div>
                        
                        <div class="w-full max-w-4xl">
                            <div id="editor-container-1"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-1">個人情報保護とキャンセルポリシー</label>
                        <div class="flex justify-between w-full max-w-4xl">
                            <p class="text-xs text-gray-500 mb-2">個人情報保護方針とキャンセルポリシーを記載</p>
                            <div class="text-xs text-gray-400"><span id="bodyCount2">0</span>/2000</div>
                        </div>
                        
                        <div class="flex items-center mb-2 gap-2">
                            <select id="templateSelect" class="mt-1 rounded-lg border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <option value="">テンプレートを選択</option>
                                <option value="opt-1">A：キャンセル可能</option>
                                <option value="opt-2">B：キャンセル不可</option>
                            </select>
                            <button id="applyTemplateBtn" class="bg-blue-500 py-2 px-4 rounded-lg text-white hover:bg-blue-600 active:scale-[0.98] transition flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">content_paste</span> テンプレートをセット
                            </button>
                        </div>

                        <div class="w-full max-w-4xl">
                            <div id="editor-container-2"></div>
                        </div>
                    </div>

                    <div class="rounded-xl border border-dashed border-gray-200 p-4 bg-gray-50/50">
                        <p class="text-sm text-gray-600">他に必要な必須項目があれば追加。</p>
                    </div>

                    </div>
                </section>
            </div>
        </main>

        <div class="fixed bottom-0 inset-x-0 z-40">
            <div class="mx-auto max-w-7xl px-6 pb-[calc(12px+var(--safe-bottom))]">
                <div class="rounded-2xl bg-white/95 backdrop-blur shadow-[0_-6px_24px_-8px_rgba(0,0,0,0.18)] border border-gray-200">
                    <div class="flex items-center justify-end gap-3 p-4">
                        <button class="h-10 px-4 rounded-lg border border-gray-300 bg-white text-gray-600 hover:bg-gray-50">キャンセル</button>
                        <button onclick="submitMock()" class="h-10 px-5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 active:scale-[.99] transition">登録する</button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Quillのブロック要素を継承して、新しいタグ <div class="info-box"> を定義します
        const Block = Quill.import('blots/block');

        class InfoBox extends Block {
            static create(value) {
                const node = super.create();
                // Tailwindのクラスをここで付与できます
                node.setAttribute('class', 'border-l-4 border-cyan-500 p-2 my-2 text-lg font-bold text-cyan-700');
                // 必要ならアイコンを入れるなども可能
                return node;
            }
        }

        // 識別キーとタグ名を指定
        InfoBox.blotName = 'info-box';
        InfoBox.tagName = 'div';

        // Quillに登録
        Quill.register(InfoBox);
        // --- Quill Editor設定 ---
        const toolbarOptions = {
            container: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'underline', 'strike'],        // toggled buttons
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                ['info-box'], // ★ここにカスタムボタンのキーを追加
                ['link', 'clean']
            ],
            handlers: {
                // ボタンが押されたときの挙動
                'info-box': function() {
                    const range = this.quill.getSelection();
                    if (range) {
                        // 現在の行を 'info-box' フォーマットにする
                        this.quill.format('info-box', true);
                    }
                }
            }
        };

        // エディタ1（本文）の初期化
        const quill1 = new Quill('#editor-container-1', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions },
            placeholder: '募集の詳細内容を入力してください...'
        });

        // エディタ2（ポリシー）の初期化
        const quill2 = new Quill('#editor-container-2', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions },
            placeholder: 'キャンセル規定などを入力してください...'
        });
        
        // --- 文字数カウントロジック ---
        const titleEl = document.getElementById('title');
        const titleCount = document.getElementById('titleCount');
        const bodyCount = document.getElementById('bodyCount');
        const bodyCount2 = document.getElementById('bodyCount2');

        // タイトル
        titleEl.addEventListener('input', () => {
            titleCount.textContent = titleEl.value.length;
        });

        // 本文（Quill 1）
        quill1.on('text-change', () => {
            // Quillは空でも最後に改行コードが入るため、実質0文字なら0とみなす処理が必要
            const text = quill1.getText();
            const length = text.replace(/\n$/, '').length; 
            bodyCount.textContent = length;
        });

        // ポリシー（Quill 2）
        quill2.on('text-change', () => {
            const text = quill2.getText();
            const length = text.replace(/\n$/, '').length;
            bodyCount2.textContent = length;
        });


        // --- テンプレート挿入ロジック ---
        const templateSelect = document.getElementById('templateSelect');
        const applyTemplateBtn = document.getElementById('applyTemplateBtn');

        const templates = {
            'opt-1': `<h3>キャンセルポリシー（通常）</h3><p>開催日の<strong>3日前</strong>まではキャンセル料は発生しません。それ以降は参加費の100%を申し受けます。</p><ul><li>連絡なしの不参加：100%</li><li>当日キャンセル：100%</li></ul>`,
            'opt-2': `<h3>キャンセルポリシー（厳格）</h3><p>お申し込み完了後の<span style="color: red;">キャンセル・返金は一切できません</span>のでご注意ください。</p><p>代理の方の参加は可能です。</p>`
        };

        applyTemplateBtn.addEventListener('click', () => {
            const val = templateSelect.value;
            if(!val) return;
            
            // 現在のカーソル位置、または末尾に挿入などの制御が可能ですが、
            // 今回は「セット」なので内容を上書き(または追記)します。
            // ここではHTMLとして挿入します。
            const html = templates[val];
            
            // 方法A: 現在の内容をクリアしてセット
            quill2.root.innerHTML = html;

            // 方法B: 末尾に追記したい場合はこちら
            // const range = quill2.getLength();
            // quill2.clipboard.dangerouslyPasteHTML(range, html);
        });


        // --- 送信モック（データ取得方法のデモ） ---
        function submitMock() {
            // QuillからHTMLデータを取得する方法
            const data = {
                title: titleEl.value,
                bodyHTML: quill1.root.innerHTML,   // ★ここでHTMLが取れます
                policyHTML: quill2.root.innerHTML, // ★ここでHTMLが取れます
                image: document.getElementById('thumbInput').files[0]?.name || 'なし'
            };
            
            console.log('送信データ:', data);
            alert('コンソールに送信データ(HTML)を出力しました。\n\n本文先頭: ' + quill1.getText().slice(0, 20) + '...');
        }


        // --- 以下、サムネイル画像の既存ロジック ---
        const drop = document.getElementById('thumbDrop');
        const dropMask = document.getElementById('thumbDropMask');
        const input = document.getElementById('thumbInput');
        const selectBtn = document.getElementById('thumbSelectBtn');
        const clearBtn = document.getElementById('thumbClearBtn');
        const preview = document.getElementById('thumbPreview');
        const empty = document.getElementById('thumbEmpty');
        const meta = document.getElementById('thumbMeta');
        const MAX_MB = 5;

        function setPreview(file){
            if(!file) return;
            const okType = /^image\//.test(file.type);
            const okSize = file.size <= MAX_MB*1024*1024;
            if(!okType || !okSize){
                alert(okType ? `サイズが大きすぎます（${MAX_MB}MBまで）` : '画像ファイルを選択してください');
                return;
            }
            const url = URL.createObjectURL(file);
            preview.src = url; preview.classList.remove('hidden'); empty.classList.add('hidden');
            clearBtn.disabled = false;
            meta.textContent = `${file.name}（${(file.size/1024/1024).toFixed(2)}MB）`;
        }
        function clearPreview(){
            preview.removeAttribute('src'); preview.classList.add('hidden'); empty.classList.remove('hidden');
            input.value = ''; meta.textContent = ''; clearBtn.disabled = true;
        }
        drop.addEventListener('click', () => input.click());
        selectBtn.addEventListener('click', () => input.click());
        input.addEventListener('change', (e) => setPreview(e.target.files?.[0]));
        ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e)=>{e.preventDefault(); dropMask.classList.remove('hidden');}));
        ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e)=>{e.preventDefault(); dropMask.classList.add('hidden');}));
        drop.addEventListener('drop', (e)=>{
            const file = e.dataTransfer.files?.[0]; if(file) setPreview(file);
        });
        clearBtn.addEventListener('click', clearPreview);
    </script>
    </body>
</html>