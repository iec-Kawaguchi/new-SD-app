<!DOCTYPE html>
<html lang="ja" class="h-full bg-gray-50">
    <head>
        <meta charset="UTF-8" />
        <title>組織構成マスター管理 - New SD App</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="./css/base-style.css">
        <script src="./js/role-visibility.js" defer></script>
        <script src="./js/mock-ui.js" defer></script>

        <style>
        </style>
    </head>
    <body class="h-full text-gray-900 antialiased flex flex-col">
        <div id="app-header"></div>
        
        <div class="flex flex-1 overflow-hidden">
            <div id="app-sidebar"></div>
            
            <main class="flex-1 flex flex-col min-w-0 bg-gray-50 h-full overflow-hidden">
                <div class="px-6 py-6 lg:px-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 shrink-0">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 tracking-tight">組織構成マスター管理</h1>
                        <p class="text-sm text-gray-500 mt-1">組織の階層構造（Level 1〜3）を定義・管理します。</p>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto" data-visible-for="iec">
                        <span class="text-sm font-bold text-gray-700 whitespace-nowrap">対象企業:</span>
                        <div class="relative w-full md:w-64">
                            <select class="h-10 appearance-none bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 pr-8 leading-tight transition-colors">
                                <option value="1">IEC株式会社</option>
                                <option value="2">テスト企業A</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <span class="material-symbols-outlined icon-sm">expand_more</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 px-6 lg:px-8 pb-6 overflow-hidden flex flex-col">
                    <div class="flex-1 bg-white border border-gray-200 rounded-xl shadow-sm flex overflow-hidden relative">
                        
                        <div class="flex-1 flex flex-col min-w-[280px] border-r border-gray-100">
                            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">階層レベル 1</span>
                                <span class="bg-white border border-gray-200 text-gray-600 text-sm px-2 py-0.5 rounded-full font-bold shadow-sm" id="count-lvl1">0</span>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1" id="list-lvl1">
                                </div>
                            <div class="p-3 border-t border-gray-100 bg-white">
                                <form id="form-lvl1" class="flex gap-2" onsubmit="return false;">
                                    <input type="text" placeholder="名称..." class="h-10 flex-1 min-w-0 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block px-3 transition-shadow" required>
                                    <button type="submit" class="h-10 flex items-center justify-center p-2 bg-white border border-gray-300 text-blue-600 rounded-md hover:bg-blue-50 hover:border-blue-200 transition shadow-sm">
                                        <span class="material-symbols-outlined icon-md">add</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col min-w-[280px] border-r border-gray-100 bg-white">
                            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">階層レベル 2</span>
                                <span class="bg-white border border-gray-200 text-gray-600 text-sm px-2 py-0.5 rounded-full font-bold shadow-sm" id="count-lvl2">-</span>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1 relative" id="list-lvl2">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none p-4 text-center">
                                    <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">arrow_back</span>
                                    <span class="text-sm">左側の「本部」を選択してください</span>
                                </div>
                            </div>
                            <div class="p-3 border-t border-gray-100 bg-white relative">
                                <div id="overlay-lvl2" class="absolute inset-0 bg-white/60 backdrop-blur-[1px] z-10 cursor-not-allowed"></div>
                                <form id="form-lvl2" class="flex gap-2" onsubmit="return false;">
                                    <input type="text" placeholder="名称..." class="h-10 flex-1 min-w-0 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block px-3 transition-shadow">
                                    <button type="submit" class="h-10 flex items-center justify-center p-2 bg-white border border-gray-300 text-blue-600 rounded-md hover:bg-blue-50 hover:border-blue-200 transition shadow-sm">
                                        <span class="material-symbols-outlined icon-md">add</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col min-w-[280px]">
                            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">階層レベル 3</span>
                                <span class="bg-white border border-gray-200 text-gray-600 text-sm px-2 py-0.5 rounded-full font-bold shadow-sm" id="count-lvl3">-</span>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1 relative" id="list-lvl3">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none p-4 text-center">
                                    <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">arrow_back</span>
                                    <span class="text-sm">左側の「部」を選択してください</span>
                                </div>
                            </div>
                            <div class="p-3 border-t border-gray-100 bg-white relative">
                                <div id="overlay-lvl3" class="absolute inset-0 bg-white/60 backdrop-blur-[1px] z-10 cursor-not-allowed"></div>
                                <form id="form-lvl3" class="flex gap-2" onsubmit="return false;">
                                    <input type="text" placeholder="名称..." class="h-10 flex-1 min-w-0 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block px-3 transition-shadow">
                                    <button type="submit" class="h-10 flex items-center justify-center p-2 bg-white border border-gray-300 text-blue-600 rounded-md hover:bg-blue-50 hover:border-blue-200 transition shadow-sm">
                                        <span class="material-symbols-outlined icon-md">add</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="px-6 py-4 bg-white border-t border-gray-200 flex justify-end gap-3 shrink-0 lg:px-8">
                    <button type="button" class="px-4 py-2 rounded-md bg-white border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm">
                        変更を破棄
                    </button>
                    <button type="button" class="px-4 py-2 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 shadow-sm hover:shadow transition-all">
                        全変更を保存する
                    </button>
                </div>
            </main>
        </div>

        <script>
            // Mock Data Generator
            const generateId = () => Math.random().toString(36).substr(2, 9);
            
            // 初期データ (親子関係を持った構造)
            const orgData = [
                {
                    id: '1', name: '営業本部', children: [
                        { id: '1-1', name: '第一営業部', children: [
                            { id: '1-1-1', name: '営業一課' },
                            { id: '1-1-2', name: '営業二課' }
                        ]},
                        { id: '1-2', name: '第二営業部', children: [] }
                    ]
                },
                {
                    id: '2', name: '管理本部', children: [
                        { id: '2-1', name: '人事総務部', children: [
                            { id: '2-1-1', name: '採用チーム' },
                            { id: '2-1-2', name: '労務チーム' }
                        ]},
                        { id: '2-2', name: '経理部', children: [] }
                    ]
                },
                { id: '3', name: 'DX推進室', children: [] }
            ];

            // State
            let currentLvl1 = null; // ID string
            let currentLvl2 = null; // ID string

            // DOM Elements
            const els = {
                list1: document.getElementById('list-lvl1'),
                list2: document.getElementById('list-lvl2'),
                list3: document.getElementById('list-lvl3'),
                count1: document.getElementById('count-lvl1'),
                count2: document.getElementById('count-lvl2'),
                count3: document.getElementById('count-lvl3'),
                overlay2: document.getElementById('overlay-lvl2'),
                overlay3: document.getElementById('overlay-lvl3'),
                form1: document.getElementById('form-lvl1'),
                form2: document.getElementById('form-lvl2'),
                form3: document.getElementById('form-lvl3'),
            };

            // Initial Render
            window.addEventListener('DOMContentLoaded', () => {
                // MockUI Setup
                if (typeof MockUI !== 'undefined') {
                    MockUI.injectHeader('#app-header', { userName: 'Test User', brand: 'New SD App' });
                    MockUI.injectSidebar('#app-sidebar');
                }
                if (typeof RoleMock !== 'undefined') {
                    RoleMock.applyRoleVisibility();
                }

                renderLvl1();
            });

            // --- Render Functions ---

            function renderLvl1() {
                els.list1.innerHTML = '';
                els.count1.textContent = orgData.length;

                orgData.forEach(item => {
                    const el = createItemElement(item, item.id === currentLvl1);
                    el.onclick = () => selectLvl1(item.id);
                    // 削除ボタンの挙動（デモ）
                    el.querySelector('[data-delete]').onclick = (e) => {
                        e.stopPropagation();
                        if(confirm('削除しますか？')) {
                            const idx = orgData.findIndex(d => d.id === item.id);
                            orgData.splice(idx, 1);
                            if(currentLvl1 === item.id) { currentLvl1 = null; currentLvl2 = null; renderLvl2(); renderLvl3(); }
                            renderLvl1();
                        }
                    };
                    els.list1.appendChild(el);
                });
            }

            function renderLvl2() {
                els.list2.innerHTML = '';
                
                if (!currentLvl1) {
                    els.count2.textContent = '-';
                    els.overlay2.classList.remove('hidden');
                    // show placeholder
                    els.list2.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none p-4 text-center"><span class="material-symbols-outlined text-4xl mb-2 text-gray-300">arrow_back</span><span class="text-sm">左側の「本部」を選択してください</span></div>`;
                    return;
                }

                const parent = orgData.find(d => d.id === currentLvl1);
                const items = parent ? parent.children : [];
                els.count2.textContent = items.length;
                els.overlay2.classList.add('hidden');

                items.forEach(item => {
                    const el = createItemElement(item, item.id === currentLvl2);
                    el.onclick = () => selectLvl2(item.id);
                    el.querySelector('[data-delete]').onclick = (e) => {
                        e.stopPropagation();
                        if(confirm('削除しますか？')) {
                            const idx = items.findIndex(d => d.id === item.id);
                            items.splice(idx, 1);
                            if(currentLvl2 === item.id) { currentLvl2 = null; renderLvl3(); }
                            renderLvl2();
                        }
                    };
                    els.list2.appendChild(el);
                });
            }

            function renderLvl3() {
                els.list3.innerHTML = '';
                
                if (!currentLvl1 || !currentLvl2) {
                    els.count3.textContent = '-';
                    els.overlay3.classList.remove('hidden');
                    els.list3.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none p-4 text-center"><span class="material-symbols-outlined text-4xl mb-2 text-gray-300">arrow_back</span><span class="text-sm">左側の「部」を選択してください</span></div>`;
                    return;
                }

                const parent1 = orgData.find(d => d.id === currentLvl1);
                const parent2 = parent1.children.find(d => d.id === currentLvl2);
                const items = parent2 ? parent2.children : [];
                
                els.count3.textContent = items.length;
                els.overlay3.classList.add('hidden');

                items.forEach(item => {
                    const el = createItemElement(item, false); // Lvl3 is leaf, no selection needed visually
                    // leaf click logic (maybe edit?)
                    el.querySelector('[data-delete]').onclick = (e) => {
                        e.stopPropagation();
                        const idx = items.findIndex(d => d.id === item.id);
                        items.splice(idx, 1);
                        renderLvl3();
                    };
                    els.list3.appendChild(el);
                });
            }

            // --- Logic Helpers ---

            function selectLvl1(id) {
                currentLvl1 = id;
                currentLvl2 = null; // reset child selection
                renderLvl1(); // update active styling
                renderLvl2();
                renderLvl3();
            }

            function selectLvl2(id) {
                currentLvl2 = id;
                renderLvl2(); // update active styling
                renderLvl3();
            }

            // HTML Element Builder
            // デザイン調整: Sky(水色)系からBlue(青)系へ変更し、ShadowやBorderの質感を統一
            function createItemElement(data, isActive) {
                const div = document.createElement('div');
                div.className = `group flex justify-between items-center p-3 rounded-lg cursor-pointer transition-all border ${
                    isActive 
                    ? 'bg-blue-50 border-blue-200 shadow-sm z-10' 
                    : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-100'
                }`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 min-w-0">
                        <span class="material-symbols-outlined icon-sm ${isActive ? 'text-blue-600' : 'text-gray-400 group-hover:text-gray-500'}">
                            ${isActive ? 'folder_open' : 'folder'}
                        </span>
                        <span class="font-medium text-sm truncate ${isActive ? 'text-blue-900' : 'text-gray-700'}">
                            ${data.name}
                        </span>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${isActive ? 'opacity-100' : ''}">
                         <button type="button" class="p-1 text-gray-400 hover:text-blue-600 rounded hover:bg-white transition" title="編集">
                            <span class="material-symbols-outlined text-[16px]">edit</span>
                        </button>
                        <button type="button" data-delete class="p-1 text-gray-400 hover:text-red-500 rounded hover:bg-white transition" title="削除">
                            <span class="material-symbols-outlined text-[16px]">delete</span>
                        </button>
                        ${isActive ? '<span class="material-symbols-outlined text-blue-400 text-[16px]">chevron_right</span>' : ''}
                    </div>
                `;
                return div;
            }

            // --- Form Handlers ---

            els.form1.addEventListener('submit', (e) => {
                const input = e.target.querySelector('input');
                if(!input.value.trim()) return;
                orgData.push({ id: generateId(), name: input.value, children: [] });
                input.value = '';
                renderLvl1();
            });

            els.form2.addEventListener('submit', (e) => {
                const input = e.target.querySelector('input');
                if(!input.value.trim()) return;
                const parent = orgData.find(d => d.id === currentLvl1);
                if(parent) {
                    parent.children.push({ id: generateId(), name: input.value, children: [] });
                    input.value = '';
                    renderLvl2();
                }
            });

            els.form3.addEventListener('submit', (e) => {
                const input = e.target.querySelector('input');
                if(!input.value.trim()) return;
                const parent1 = orgData.find(d => d.id === currentLvl1);
                const parent2 = parent1.children.find(d => d.id === currentLvl2);
                if(parent2) {
                    parent2.children.push({ id: generateId(), name: input.value });
                    input.value = '';
                    renderLvl3();
                }
            });

        </script>
    </body>
</html>